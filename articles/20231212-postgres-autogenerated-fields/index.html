<html lang="en">

<head>
  <meta charset="UTF-8">
  

  
  <title>Postgres: Using SQL generated columns</title>
  

  
  
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;700&display=swap"
    rel="stylesheet">

  <link class="stylesheet" rel="stylesheet" href="/main.css" />
  <link class="stylesheet" rel="stylesheet" href="/dark.css" />

  <meta name="description" content="A brief introduction to SQL autogenerated fields with Postgres." />
</head>

<body class="stylesheet-mode" onload="loadActiveStylesheet()">
  <script type="text/javascript">
    function getStylesheetModeTags() {
      return document.getElementsByClassName("stylesheet-mode");
    }

    function getStylesheetTogglerTags() {
      return document.getElementsByClassName("stylesheet-toggler");
    }

    function loadActiveStylesheet() {
      var activeStylesheet = localStorage.getItem("active-stylesheet");

      if (["dark", "light"].indexOf(activeStylesheet) == -1) {
        activeStylesheet = "dark";
      }

      var classes = "stylesheet-mode " + activeStylesheet;

      for (elem of getStylesheetModeTags()) {
        elem.setAttribute("class", classes);
      }

      updateGiscusStyle(activeStylesheet);
    }

    function getIconNameForMode(mode) {
      if (mode == "dark") {
        return "sunny";
      }
      return "moon";
    }

    function sendToIframe(iframe, message, url) {
      iframe.contentWindow.postMessage(message, url);
    }

    function sendToGiscus(message) {
      var iframe = document.querySelector("iframe.giscus-frame");

      // WORKAROUND:
      // If the iframe is loaded, we apply the new theme instantly.
      // If it's not, then we delay the loading, so that the default "dark"
      // theme won't override it once the iframe is loaded (on first page load).
      // SHORTCOMINGS:
      // This can display a dark Giscus inside a light page for a few seconds...
      // But it prevents displaying a broken form or duplicating the iframe.
      if (iframe) {
        sendToIframe(iframe, { giscus: message }, "https://giscus.app");
      } else {
        setTimeout(sendToGiscus, 3000, message)
      }
    }

    function updateGiscusStyle(mode) {
      var theme = mode == "dark" ? "dark" : "light";

      sendToGiscus({
        setConfig: {
          theme: theme
        }
      });
    }

    function switchStylesheets() {
      var activeMode = "dark";

      for (elem of getStylesheetModeTags()) {
        switch (elem.className) {
          case "stylesheet-mode dark":
            activeMode = "light";
            break;

          case "stylesheet-mode light":
            activeMode = "dark";
            break;

          default:
            activeMode = "dark";
            break;
        }

        elem.setAttribute("class", "stylesheet-mode " + activeMode);
      }

      localStorage.setItem("active-stylesheet", activeMode);
      updateGiscusStyle(activeMode);
    }
  </script>

  <script type="text/javascript">loadActiveStylesheet();</script>
  <div id='stars'></div>
  <div id='stars2'></div>
  <div id='stars3'></div>

  <main class="
      m-auto max-w-full h-screen overflow-y-scroll overflow-x-hidden
      text-black dark:text-white bg-blue-900 dark:bg-transparent
    ">
    <div class="w-228 max-w-screen m-auto p-4 bg-slate-200 dark:bg-transparent">
      <div class="
    sticky h-12 w-11/12 m-auto mt-4 mb-4 p-1 -top-px rounded-md
    bg-black bg-opacity-100 shadow-2xl
    dark:bg-black dark:bg-opacity-80 dark:shadow-transparent
">
  <nav class="h-full w-full relative">
    <ul
      class="w-full h-full m-auto p-0 flex flex-row flex-nowrap justify-center items-center list-none">
      
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;">Home</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;articles">Articles</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;demos">Demos</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;tags">Tags</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;contact">Contact</a>
      </li>
      
      <li class="ml-auto">
        <a class="
            inline-block no-underline p-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
          dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          onClick="switchStylesheets()">
          <ion-icon class="stylesheet-toggler inline-block dark:hidden"
            name="moon"></ion-icon>
          <ion-icon class="stylesheet-toggler hidden dark:inline-block"
            name="sunny"></ion-icon>
        </a>
      </li>
    </ul>
  </nav>
</div>

      <div class="
        w-11/12 m-auto mt-2 p-4
        flex justify-center
        flex-col flex-wrap
        lg:flex-row lg:flex-nowrap
        dark:bg-black dark:bg-opacity-60
    ">
        


<aside class="w-full lg:w-3/12">
  <div class="sticky flex top-50">
    <ol class="w-full m-0 pl-4 list-decimal">
      
      <li>
        
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/#context" title="Context">
  Context
</a>

        
      </li>
      
      <li>
        
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/#usage" title="Usage">
  Usage
</a>

        
      </li>
      
      <li>
        
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/#implications" title="Implications">
  Implications
</a>

        
        <ol>
          
          <li>
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/#introducing-new-foreign-keys" title="Introducing new foreign keys">
  Introducing new foreign keys
</a>
</li>
          
          <li>
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/#testing" title="Testing">
  Testing
</a>
</li>
          
        </ol>
        
      </li>
      
      <li>
        
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/#conclusion" title="Conclusion">
  Conclusion
</a>

        
      </li>
      
    </ol>
  </div>
</aside>



<article class="w-full lg:w-9/12 pt-1 pb-1 pl-4">

  <header class="text-center">
    <h1 class="text-2xl font-bold m-2 p-2">
      Postgres: Using SQL generated columns
    </h1>
    
    <p class="subtitle">
      Published on 2024-01-30
    </p>
    
    
    
<p class="max-w-fit m-auto">
  
  <a class="inline-block m-1 p-1 underline hover:no-underline"
    href="/tags/tutorial">
    tutorial
  </a>
  
  <a class="inline-block m-1 p-1 underline hover:no-underline"
    href="/tags/postgres">
    postgres
  </a>
  
</p>

    
  </header>

  

  

  

  <div class="markdown-content">
    <h2 id="context">Context</h2>
<p><strong>Attention: This feature isn't specific to PG, but that's the only RDBMS I use on a regular basis, so variations may apply.</strong></p>
<blockquote>
<p>TL;DR: You can define a field generated at row insertion, instead of inferring a dynamic value.</p>
</blockquote>
<p>When designing your data model using a relational database, you might encounter a case where you'd need to link a table to numerous other tables.</p>
<p>In that case, you might be tempted to use a polymorphic association, but this comes at the cost of sacrificing data integrity with the loss of foreign keys.</p>
<p>One simple alternative consists of having one foreign key per relation. It is simple and reliable, at least until you reach a large number of foreign keys.</p>
<p>Let's say we have the following schema:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>items
</span><span>----        todos
</span><span>id          -----
</span><span>todo_id --&gt; id      posts
</span><span>...         title   -----
</span><span>post_id ----------&gt; id
</span><span>                    title
</span></code></pre>
<p>We might want to know the "type" of relation our row is linked to, without having to use a case-when statement on each SQl query, which would be costly - and/or at least inefficient.</p>
<p>How about adding a string field representing the relation type? It's fine. But our model may change, and we might have to declare a new type, and yet forget to add the new possible value.</p>
<p>This is a situation where SQL generated columns can be handy.</p>
<h2 id="usage">Usage</h2>
<p>A generated column is typically created like this:</p>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">ALTER TABLE </span><span>$TABLE_NAME ADD COLUMN $FIELD_NAME $FIELD_TYPE GENERATED AS (
</span><span>  $GENERATION_EXPRESSION
</span><span>) STORED;
</span></code></pre>
<p>A few key points here:</p>
<ul>
<li><code>$GENERATION_EXPRESSION</code> can be any statement returning a value,</li>
<li>Postgres only supports stored values.</li>
</ul>
<p>So, in our case, the field definition would look like this:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>ALTER TABLE items ADD COLUMN relation_type string GENERATED AS (
</span><span>  CASE
</span><span>    WHEN &#39;post_id&#39; IS NOT NULL THEN &#39;post&#39;
</span><span>    WHEN &#39;todo_id&#39; IS NOT NULL THEN &#39;todo&#39;
</span><span>  END
</span><span>) STORED;
</span></code></pre>
<h2 id="implications">Implications</h2>
<h3 id="introducing-new-foreign-keys">Introducing new foreign keys</h3>
<p>You may need to introduce new foreign keys. In that case, you'll need to alter the table again and add a new condition to your generator expression.</p>
<p>You might be tempted to add a default "unknown" value, but I think explicit failure should be prefered in that case.</p>
<h3 id="testing">Testing</h3>
<p>Since we basically have an enumeration, we might want to iterate over this enumeration in our tests, so that we can check that our codebase actually handles all the possible values it can take (eg. for exposing values on a GraphQL API).</p>
<p>And it turns out we can retrieve that information from Postgres!</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>SELECT generation_expression
</span><span>        FROM information_schema.columns
</span><span>        WHERE table_schema = &#39;public&#39;
</span><span>        AND table_name   = &#39;items&#39;
</span><span>        AND column_name = &#39;relation_type&#39;;
</span></code></pre>
<p>This will return the raw SQL statement used to generate new values. It's a bit sketchy, but you can parse this expression with simple regexps and extract what you need.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Generated fields are a simple but powerful tool, and you can use it in a lot of scenarios I didn't mention, such as generating a tsvector for full text search, or simplifying basic yet cumbersome checks.</p>

  </div>

  
  <script src="https://giscus.app/client.js"
    data-repo="mbuffa/mbuffa.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyNDYzOTIyNjU="
    data-category="Announcements" data-category-id="DIC_kwDODq-lyc4CAZ1r"
    data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0"
    data-theme="dark" data-lang="en" crossorigin="anonymous" async>
    </script>
  
</article>

      </div>

      <footer class="mt-20 p-4 text-center text-xs font-normal">
  <span>
    Written by Maxime Buffa with <a class="dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
      href="https://www.getzola.org/" target="_blank">Zola</a> and <a
      class="dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900" href="https://tailwindcss.com/"
      target="_blank">Tailwind</a>
  </span>
</footer>
    </div>
    <!-- Fix to avoid scrolling "under the overflow break" when using a ToC link.
    <br>
  </main>

  <!-- Heap Analytics loader -->
    <script type="text/javascript">
      window.heap = window.heap || [], heap.load = function (e, t) { window.heap.appid = e, window.heap.config = t = t || {}; var r = document.createElement("script"); r.type = "text/javascript", r.async = !0, r.src = "https://cdn.heapanalytics.com/js/heap-" + e + ".js"; var a = document.getElementsByTagName("script")[0]; a.parentNode.insertBefore(r, a); for (var n = function (e) { return function () { heap.push([e].concat(Array.prototype.slice.call(arguments, 0))) } }, p = ["addEventProperties", "addUserProperties", "clearEventProperties", "identify", "resetIdentity", "removeEventProperty", "setEventProperties", "track", "unsetEventProperty"], o = 0; o < p.length; o++)heap[p[o]] = n(p[o]) };
      heap.load("4008293954");
    </script>
    <script
      src="https://unpkg.com/ionicons@5.2.3/dist/ionicons/ionicons.js"></script>
    <script type="module"
      src="https://unpkg.com/ionicons@5.2.3/dist/ionicons/ionicons.esm.js"></script>
</body>

</html>