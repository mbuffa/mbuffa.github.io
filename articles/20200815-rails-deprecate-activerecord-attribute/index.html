<html lang="en">

<head>
  <meta charset="UTF-8">
  

  
  <title>Rails: Deprecate an ActiveRecord attribute</title>
  

  
  
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;700&display=swap"
    rel="stylesheet">

  <link class="stylesheet" rel="stylesheet" href="/main.css" />
  <link class="stylesheet" rel="stylesheet" href="/dark.css" />

  <meta name="description" content="My personal website with tips and rants." />
</head>

<body class="stylesheet-mode" onload="loadActiveStylesheet()">
  <script type="text/javascript">
    function getStylesheetModeTags() {
      return document.getElementsByClassName("stylesheet-mode");
    }

    function getStylesheetTogglerTags() {
      return document.getElementsByClassName("stylesheet-toggler");
    }

    function loadActiveStylesheet() {
      var activeStylesheet = localStorage.getItem("active-stylesheet");

      if (["dark", "light"].indexOf(activeStylesheet) == -1) {
        activeStylesheet = "dark";
      }

      var classes = "stylesheet-mode " + activeStylesheet;

      for (elem of getStylesheetModeTags()) {
        elem.setAttribute("class", classes);
      }

      updateGiscusStyle(activeStylesheet);
    }

    function getIconNameForMode(mode) {
      if (mode == "dark") {
        return "sunny";
      }
      return "moon";
    }

    function sendToIframe(iframe, message, url) {
      iframe.contentWindow.postMessage(message, url);
    }

    function sendToGiscus(message) {
      var iframe = document.querySelector("iframe.giscus-frame");

      // WORKAROUND:
      // If the iframe is loaded, we apply the new theme instantly.
      // If it's not, then we delay the loading, so that the default "dark"
      // theme won't override it once the iframe is loaded (on first page load).
      // SHORTCOMINGS:
      // This can display a dark Giscus inside a light page for a few seconds...
      // But it prevents displaying a broken form or duplicating the iframe.
      if (iframe) {
        sendToIframe(iframe, { giscus: message }, "https://giscus.app");
      } else {
        setTimeout(sendToGiscus, 3000, message)
      }
    }

    function updateGiscusStyle(mode) {
      var theme = mode == "dark" ? "dark" : "light";

      sendToGiscus({
        setConfig: {
          theme: theme
        }
      });
    }

    function switchStylesheets() {
      var activeMode = "dark";

      for (elem of getStylesheetModeTags()) {
        switch (elem.className) {
          case "stylesheet-mode dark":
            activeMode = "light";
            break;

          case "stylesheet-mode light":
            activeMode = "dark";
            break;

          default:
            activeMode = "dark";
            break;
        }

        elem.setAttribute("class", "stylesheet-mode " + activeMode);
      }

      localStorage.setItem("active-stylesheet", activeMode);
      updateGiscusStyle(activeMode);
    }
  </script>

  <script type="text/javascript">loadActiveStylesheet();</script>
  <div id='stars'></div>
  <div id='stars2'></div>
  <div id='stars3'></div>

  <main class="
      m-auto max-w-full h-screen overflow-y-scroll overflow-x-hidden
      text-black dark:text-white bg-blue-900 dark:bg-transparent
    ">
    <div class="w-228 max-w-screen m-auto p-4 bg-slate-200 dark:bg-transparent">
      <div class="
    sticky h-12 w-11/12 m-auto mt-4 mb-4 p-1 -top-px rounded-md
    bg-black bg-opacity-100 shadow-2xl
    dark:bg-black dark:bg-opacity-80 dark:shadow-transparent
">
  <nav class="h-full w-full relative">
    <ul
      class="w-full h-full m-auto p-0 flex flex-row flex-nowrap justify-center items-center list-none">
      
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;">Home</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;articles">Articles</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;demos">Demos</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;tags">Tags</a>
      </li>
      
      <li>
        <a class="
            inline-block no-underline p-4 pt-1 pb-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
            dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          href="&#x2F;contact">Contact</a>
      </li>
      
      <li class="ml-auto">
        <a class="
            inline-block no-underline p-1 hover:no-underline border border-solid rounded-md border-transparent
            text-white hover:bg-white hover:text-black active:text-black
          dark:text-orange-500 dark:hover:bg-orange-500 dark:hover:text-neutral-900 dark:active:text-white"
          onClick="switchStylesheets()">
          <ion-icon class="stylesheet-toggler inline-block dark:hidden"
            name="moon"></ion-icon>
          <ion-icon class="stylesheet-toggler hidden dark:inline-block"
            name="sunny"></ion-icon>
        </a>
      </li>
    </ul>
  </nav>
</div>

      <div class="
        w-11/12 m-auto mt-2 p-4
        flex justify-center
        flex-col flex-wrap
        lg:flex-row lg:flex-nowrap
        dark:bg-black dark:bg-opacity-60
    ">
        


<aside class="w-full lg:w-3/12">
  <div class="sticky flex top-50">
    <ol class="w-full m-0 pl-4 list-decimal">
      
      <li>
        
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20200815-rails-deprecate-activerecord-attribute/#context" title="Context">
  Context
</a>

        
      </li>
      
      <li>
        
<a class="
    inline-block px-2 text-sm w-full underline hover:no-underline
  dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
  href="https://mbuffa.github.io/articles/20200815-rails-deprecate-activerecord-attribute/#how" title="How">
  How
</a>

        
      </li>
      
    </ol>
  </div>
</aside>



<article class="w-full lg:w-9/12 pt-1 pb-1 pl-4">

  <header class="text-center">
    <h1 class="text-2xl font-bold m-2 p-2">
      Rails: Deprecate an ActiveRecord attribute
    </h1>
    
    <p class="subtitle">
      Published on 2020-08-15
    </p>
    
    
    
<p class="max-w-fit m-auto">
  
  <a class="inline-block m-1 p-1 underline hover:no-underline"
    href="/tags/tip">
    tip
  </a>
  
  <a class="inline-block m-1 p-1 underline hover:no-underline"
    href="/tags/rails">
    rails
  </a>
  
</p>

    
  </header>

  

  

  

  <div class="markdown-content">
    <h2 id="context">Context</h2>
<p>When working on a growing application relying on a database, it is not uncommon to have a data model that collects dust: some of its data may become obsolete, but you may not want to delete it just yet, because you may need to migrate it, prepare its deletion later or keep it as history.</p>
<p>You might want to flag this data as deprecated, so that no one (including you) would rely on this no longer updated or relevant data.</p>
<h2 id="how">How</h2>
<p>You could of course add comments in your code, but there would be no guarantee someone would check those comments before using those attributes. Also, you wouldn't notice anything if existing code would use those attributes indirectly.</p>
<p>Fortunately, Rails provides <a href="https://apidock.com/rails/v4.0.2/Module/deprecate">a nice way to flag ActiveRecord attributes as obsolete</a>, stabilized since Rails 4.x.</p>
<p>Let's create a <code>Deprecator</code> class, that'll embed any behavior we'd like to implement. We can be creative here, like:</p>
<ul>
<li>logging the action</li>
<li>logging parts of the stacktrace</li>
<li>shaming your coworkers on Slack with a bot message</li>
</ul>
<p>But let's keep it simple for the time being:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;"># app/deprecators/field_deprecator.rb
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">FieldDeprecator
</span><span style="color:#eff1f5;">  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">deprecation_warning</span><span>(</span><span style="color:#bf616a;">field</span><span>, </span><span style="color:#bf616a;">replacement</span><span>, </span><span style="color:#bf616a;">_caller_backtrace </span><span>= </span><span style="color:#d08770;">nil</span><span>)
</span><span>    message = &quot;#{field}</span><span style="color:#a3be8c;"> is deprecated, please favor </span><span>#{replacement}&quot;
</span><span>    </span><span style="color:#ebcb8b;">Kernel</span><span>.</span><span style="color:#96b5b4;">warn</span><span> message
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>We're not respecting the semantics of the second argument, but hey, this is duck-typing :trollface:</p>
<p>Then, all we have to do is to add a call to this class method in our model:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Racoon </span><span style="color:#eff1f5;">&lt; </span><span style="color:#a3be8c;">ApplicationRecord
</span><span>  deprecate \
</span><span>    </span><span style="color:#a3be8c;">owner_id: </span><span>&#39;</span><span style="color:#a3be8c;">Racoon#caretaker_id</span><span>&#39;,
</span><span>    </span><span style="color:#65737e;"># ... any other attribute you need to deprecate.
</span><span>    </span><span style="color:#a3be8c;">deprecator: </span><span style="color:#ebcb8b;">FieldDeprecator</span><span>.</span><span style="color:#8fa1b3;">new
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>With our current deprecator, this would output a warning message everytime this field is being read and updated:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&gt; Racoon.first.owner_id
</span><span>owner_id is deprecated, please favor Racoon#caretaker_id
</span></code></pre>
<p><em>Et voilà.</em></p>

  </div>

  
  <script src="https://giscus.app/client.js"
    data-repo="mbuffa/mbuffa.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkyNDYzOTIyNjU="
    data-category="Announcements" data-category-id="DIC_kwDODq-lyc4CAZ1r"
    data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0"
    data-theme="dark" data-lang="en" crossorigin="anonymous" async>
    </script>
  
</article>

      </div>

      <footer class="mt-20 p-4 text-center text-xs font-normal">
  <span>
    Written by Maxime Buffa with <a class="dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900"
      href="https://www.getzola.org/" target="_blank">Zola</a> and <a
      class="dark:text-orange-500 dark:hover:text-orange-500 dark:hover:bg-neutral-900" href="https://tailwindcss.com/"
      target="_blank">Tailwind</a>
  </span>
</footer>
    </div>
    <!-- Fix to avoid scrolling "under the overflow break" when using a ToC link.
    <br>
  </main>

  <!-- Heap Analytics loader -->
    <script type="text/javascript">
      window.heap = window.heap || [], heap.load = function (e, t) { window.heap.appid = e, window.heap.config = t = t || {}; var r = document.createElement("script"); r.type = "text/javascript", r.async = !0, r.src = "https://cdn.heapanalytics.com/js/heap-" + e + ".js"; var a = document.getElementsByTagName("script")[0]; a.parentNode.insertBefore(r, a); for (var n = function (e) { return function () { heap.push([e].concat(Array.prototype.slice.call(arguments, 0))) } }, p = ["addEventProperties", "addUserProperties", "clearEventProperties", "identify", "resetIdentity", "removeEventProperty", "setEventProperties", "track", "unsetEventProperty"], o = 0; o < p.length; o++)heap[p[o]] = n(p[o]) };
      heap.load("4008293954");
    </script>
    <script
      src="https://unpkg.com/ionicons@5.2.3/dist/ionicons/ionicons.js"></script>
    <script type="module"
      src="https://unpkg.com/ionicons@5.2.3/dist/ionicons/ionicons.esm.js"></script>
</body>

</html>