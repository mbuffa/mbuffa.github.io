<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title></title>
      <link>https://mbuffa.github.io</link>
      <description></description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://mbuffa.github.io/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Tue, 20 Jan 2026 00:00:00 +0000</lastBuildDate>
      <item>
          <title>Blog: Hacking my Linux server at home - Part 2</title>
          <pubDate>Tue, 20 Jan 2026 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20260120-blog-server-hacking-part-two/</link>
          <guid>https://mbuffa.github.io/articles/20260120-blog-server-hacking-part-two/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20260120-blog-server-hacking-part-two/">&lt;h3 id=&quot;see-also&quot;&gt;See also&lt;&#x2F;h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;articles&#x2F;20251110-blog-server-hacking-part-one&quot;&gt;Part One&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;In my previous post, I mentioned setting up a home server, which was at this point not doing a lot of things, aside from having a PostgreSQL database and a SSH server.&lt;&#x2F;p&gt;
&lt;p&gt;In this post, I&#x27;ll go into details how I managed to get those components up and running:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A working Gitea (alternative to GitHub),&lt;&#x2F;li&gt;
&lt;li&gt;A CI Runner, compatible with GitHub Actions, for tests and deployments,&lt;&#x2F;li&gt;
&lt;li&gt;A docker registry to hold my services images,&lt;&#x2F;li&gt;
&lt;li&gt;A Kubernetes cluster, using Minikube,&lt;&#x2F;li&gt;
&lt;li&gt;A Cloudflare Tunnel, to expose my services to the World Wide Web,&lt;&#x2F;li&gt;
&lt;li&gt;And finally, the Systemd configuration files needed to make all of this work (almost) smoothly.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;So, let&#x27;s move on! I&#x27;ll try not to flood this page with configuration files though, to keep it clean and simple.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;gitea&quot;&gt;Gitea&lt;&#x2F;h2&gt;
&lt;p&gt;Gitea was &lt;a href=&quot;https:&#x2F;&#x2F;docs.gitea.com&#x2F;category&#x2F;installation&quot;&gt;straightforward to install&lt;&#x2F;a&gt;. In my case, there was a Arch Linux package ready for me, so I just picked that option. The idea was to have something up and running, with the least possible number of abstractions and dependencies, so I didn&#x27;t think about running it inside Kubernetes, or a VM. At least, not for now.&lt;&#x2F;p&gt;
&lt;p&gt;Gitea requires a SQL database, so you&#x27;d definitely need to provide one, and check that the Postgres database would accept connections for the &lt;code&gt;gitea&lt;&#x2F;code&gt; user in the usual &lt;code&gt;&#x2F;var&#x2F;lib&#x2F;postgres&#x2F;data&#x2F;pg_hba.conf&lt;&#x2F;code&gt; configuration file:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# TYPE  DATABASE        USER            ADDRESS                 METHOD
&lt;&#x2F;span&gt;&lt;span&gt;local   giteadb         gitea                                   scram-sha-256
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I believe the package was bundled with the proper Systemd config, so a simple &lt;code&gt;systemctl enable gitea&lt;&#x2F;code&gt; was enough to add it to the services Systemd would start on the next reboot.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;One important note though&lt;&#x2F;strong&gt;: In my case, the gitea user was configured with a password reset every six months. So, one morning, I had the sad surprise of realizing something was broken in my setup. You can check if your password has expired by running &lt;code&gt;chage -l YOUR_USER&lt;&#x2F;code&gt; and &lt;code&gt;chage -E -1 YOUR_USER&lt;&#x2F;code&gt; to disable the password reset.&lt;&#x2F;p&gt;
&lt;p&gt;In my case, since my Gitea user was forbidden from TTY login, I decided to disable the password reset. It didn&#x27;t seem very impactful to do so. And that user would be used only with SSH handshakes to save Git repos on disk (and, yeah, run the CI too).&lt;&#x2F;p&gt;
&lt;p&gt;After this initial setup, I was happy to open my numerous and unfinished Git repositories and run &lt;code&gt;git remote add self gitea@SERVER:USER&#x2F;REPO.git&lt;&#x2F;code&gt;.
When it would be time to push upstream, a simple &lt;code&gt;git push&lt;&#x2F;code&gt; and &lt;code&gt;git push self&lt;&#x2F;code&gt; (or &lt;code&gt;gp&lt;&#x2F;code&gt; and &lt;code&gt;gp self&lt;&#x2F;code&gt; with shortcuts) would be enough to send to both my GitHub account and my Gitea server.&lt;&#x2F;p&gt;
&lt;p&gt;I needed a CI to run tests though, but that was requiring two dependencies. Let&#x27;s move to the next one.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-ci-runner&quot;&gt;The CI Runner&lt;&#x2F;h2&gt;
&lt;p&gt;Gitea supports Github Actions, or &lt;a href=&quot;https:&#x2F;&#x2F;www.drone.io&#x2F;&quot;&gt;Drone CI&lt;&#x2F;a&gt;. I decided to go with the first option, as I already had a few GitHub 4s working. I wanted backward compatibility, and to be able to deploy from GitHub in the event that my server would go down.&lt;&#x2F;p&gt;
&lt;p&gt;I think I will eventually migrate, to, maybe, &lt;a href=&quot;https:&#x2F;&#x2F;argoproj.github.io&#x2F;cd&quot;&gt;ArgoCD&lt;&#x2F;a&gt; though, as GitHub Actions isn&#x27;t great by itself, and, as I would discover later, Gitea doesn&#x27;t actually support 100% of GitHub Actions. Some differences may emerge, regarding services hostnames within a test step, for example.&lt;&#x2F;p&gt;
&lt;p&gt;But anyway, we needed Docker. Just one package to install, and to make sure the service would start on boot, and we were good to go.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;a href=&quot;https:&#x2F;&#x2F;gitea.com&#x2F;gitea&#x2F;act_runner&quot;&gt;Act Runner repository&lt;&#x2F;a&gt; is a good place if you want quick notes on how to install and configure it. Downloaded the binary, ran the command to register the runner, and pasted the token I generated inside Gitea, so that the runner would be able to use it.&lt;&#x2F;p&gt;
&lt;p&gt;Remember that I&#x27;m using a single machine infrastructure. I may eventually get another Thinkcentre, so that I can declare a new K8s node on it, and have redundancy on my services, but for now, I&#x27;m configuring things on only one server, so some security configuration may apply if you decide to setup a swarm of machines.&lt;&#x2F;p&gt;
&lt;p&gt;It was relatively easy to have simple CI tasks such as tests to work. However, I wanted to be also able to deploy both trunk (automatically) and feature branches (manually). This is one part where I wished GitHub Actions was as good as Gitlab CI, because I wasn&#x27;t able to DRY my CI with a single &quot;deployment&quot; step with various triggers. I had to declare two separate workflows.&lt;&#x2F;p&gt;
&lt;p&gt;But anyway, we need a Kubernetes cluster, right?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;minikube&quot;&gt;Minikube&lt;&#x2F;h2&gt;
&lt;p&gt;When it comes to having Kubernetes on your calculator, you have a few options, at least three:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Minikube,&lt;&#x2F;li&gt;
&lt;li&gt;K3s,&lt;&#x2F;li&gt;
&lt;li&gt;and MicroK8s.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;At least.&lt;&#x2F;p&gt;
&lt;p&gt;To be honest with you there, I quickly watched Canonical&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;canonical.com&#x2F;microk8s&#x2F;compare&quot;&gt;comparison table&lt;&#x2F;a&gt;, saw that there was an Arch package for Minikube, and not for the other ones, and decided to go with it.&lt;&#x2F;p&gt;
&lt;p&gt;Not a professional benchmark, so you would say, but I&#x27;ll swap the cluster &quot;distribution&quot; the day I lay my hands on another Thinkcentre, as I said, or even buy proper servers.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, installing Minikube was very easy, but I wrote my own Systemd service since it wasn&#x27;t bundled with one:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;[root@tinker makkusu]# cat &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;minikube.service 
&lt;&#x2F;span&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=Kickoff Minikube Cluster
&lt;&#x2F;span&gt;&lt;span&gt;After=docker.service
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=oneshot
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;usr&#x2F;bin&#x2F;minikube start --apiserver-ips=ETHERNET_ADDR
&lt;&#x2F;span&gt;&lt;span&gt;RemainAfterExit=true
&lt;&#x2F;span&gt;&lt;span&gt;ExecStop=&#x2F;usr&#x2F;bin&#x2F;minikube stop
&lt;&#x2F;span&gt;&lt;span&gt;StandardOutput=journal
&lt;&#x2F;span&gt;&lt;span&gt;User=makkusu
&lt;&#x2F;span&gt;&lt;span&gt;Group=makkusu
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;--apiserver&lt;&#x2F;code&gt; part is interesting. Since my server does have two interfaces (a wireless, and an ethernet one), i needed to specify one in order to be able to use &lt;code&gt;kubectl&lt;&#x2F;code&gt; on my laptop. I believe you may use &lt;code&gt;0.0.0.0&lt;&#x2F;code&gt; here.&lt;&#x2F;p&gt;
&lt;p&gt;I also had to make sure it would run after the docker service was started, because I ended up using Docker&#x27;s registry for images pull. Minikube does come with its own registry, but I wasn&#x27;t able to make my cluster pull from it.&lt;&#x2F;p&gt;
&lt;p&gt;Also, I decided to make it run under my user, just like the basic official example shows. One would &lt;strong&gt;probably&lt;&#x2F;strong&gt; want to isolate the runtime to a user that isn&#x27;t in the &lt;code&gt;sudoers&lt;&#x2F;code&gt; list though... I&#x27;ll probably try to setup MicroK8s this way at some point.&lt;&#x2F;p&gt;
&lt;p&gt;Once the cluster is started, you can check that it&#x27;s running by just using &lt;code&gt;kubectl get pods&lt;&#x2F;code&gt; or deploying hello world apps on it.
I wanted to be able to run &lt;code&gt;kubectl&lt;&#x2F;code&gt; from my laptop though, and this required generating a certificate on the server, copy it to my laptop alongside the &lt;code&gt;~&#x2F;.kube&#x2F;config&lt;&#x2F;code&gt; configuration, and adapt the hostname. I won&#x27;t copy that here for obvious reasons.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, that&#x27;s where the &quot;interesting stuff&quot; begins.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;making-the-runner-actually-deploy&quot;&gt;Making the Runner actually deploy&lt;&#x2F;h2&gt;
&lt;p&gt;This is where things got interesting, and it required me a bit of trial and error to get it right, or at least working. I&#x27;m sure there is some streamlining (and hardening) opportunity at arm&#x27;s length.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ll spare you the details about the intermediate steps, but it took a bit of work:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;to get the runner to be able to push Docker images to Minikube&#x27;s registry,&lt;&#x2F;li&gt;
&lt;li&gt;to be able to connect to Minikube&#x27;s API to run kubectl commands in the runner (like &lt;code&gt;kubectl apply -f&lt;&#x2F;code&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;realize pods weren&#x27;t able to pull images,&lt;&#x2F;li&gt;
&lt;li&gt;set the runner to push Docker images to Docker&#x27;s registry instead,&lt;&#x2F;li&gt;
&lt;li&gt;and have every bit work without breaking another.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;And this required a bit of TCP port forwarding. So I needed to add 2 Systemd services using &lt;code&gt;socat&lt;&#x2F;code&gt; to route traffic:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;From the Docker IP to my Minikube&#x27;s registry IP (and port),&lt;&#x2F;li&gt;
&lt;li&gt;From Any IP to my Minikube API IP (so that kubectl would work in the runner AND on external devices on the network),&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This resulted in those two files:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# minikube-registry-forward.service
&lt;&#x2F;span&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=Forward Docker bridge to Minikube registry
&lt;&#x2F;span&gt;&lt;span&gt;After=minikube.service
&lt;&#x2F;span&gt;&lt;span&gt;Requires=minikube.service
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=simple
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;usr&#x2F;bin&#x2F;socat TCP-LISTEN:5000,bind=DOCKER_IP,fork,reuseaddr TCP:MINIKUBE_IP:5000
&lt;&#x2F;span&gt;&lt;span&gt;Restart=always
&lt;&#x2F;span&gt;&lt;span&gt;RestartSec=5
&lt;&#x2F;span&gt;&lt;span&gt;StandardOutput=journal
&lt;&#x2F;span&gt;&lt;span&gt;StandardError=journal
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# minikube-api-forward.service 
&lt;&#x2F;span&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=Forward Docker bridge to Minikube API server
&lt;&#x2F;span&gt;&lt;span&gt;After=minikube.service docker.service
&lt;&#x2F;span&gt;&lt;span&gt;Requires=minikube.service docker.service
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=simple
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;usr&#x2F;bin&#x2F;socat TCP-LISTEN:8443,fork,bind=0.0.0.0,reuseaddr TCP:MINIKUBE_IP:8443 
&lt;&#x2F;span&gt;&lt;span&gt;Restart=always
&lt;&#x2F;span&gt;&lt;span&gt;RestartSec=5
&lt;&#x2F;span&gt;&lt;span&gt;StandardOutput=journal
&lt;&#x2F;span&gt;&lt;span&gt;StandardError=journal
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;# Security hardening
&lt;&#x2F;span&gt;&lt;span&gt;NoNewPrivileges=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateTmp=true
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now that I see it posted, it seems ridiculously straightforward. But I did loose a bit of hair when trying to figure out why my CI would work one day, and would stop working the next one, after I fixed &lt;code&gt;kubectl&lt;&#x2F;code&gt; on my laptop.&lt;&#x2F;p&gt;
&lt;p&gt;I previously mentioned that my k8s pods weren&#x27;t able to pull images initially. I honestly do not remember what the message was, and maybe I was just missinbg a port forward, or some authorization, but I ended up using Docker&#x27;s registry anyway.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;one-more-port-forward&quot;&gt;One more port forward&lt;&#x2F;h3&gt;
&lt;p&gt;One more port forward needed to route HTTPS traffic to the cluster&#x27;s ingress!&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# ingress-https-forward.service
&lt;&#x2F;span&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=Forward HTTPS to Minikube Ingress NodePort
&lt;&#x2F;span&gt;&lt;span&gt;After=network.target
&lt;&#x2F;span&gt;&lt;span&gt;After=minikube.service
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=simple
&lt;&#x2F;span&gt;&lt;span&gt;ExecStartPre=&#x2F;bin&#x2F;bash -c &amp;#39;until nc -z MINIKUBE_API_IP 32655; do sleep 5; done&amp;#39;
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;usr&#x2F;bin&#x2F;socat TCP-LISTEN:443,bind=0.0.0.0,fork,reuseaddr TCP:MINIKUBE_API_IP:32655
&lt;&#x2F;span&gt;&lt;span&gt;Restart=always
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is an interesting one. You can see that I&#x27;m starting the service after the network interface and minikube are started. But that doesn&#x27;t mean they would be ready to use.&lt;&#x2F;p&gt;
&lt;p&gt;Hence the &lt;code&gt;ExecStartPre=&#x2F;bin&#x2F;bash -c &#x27;until nc -z MINIKUBE_API_IP 32655; do sleep 5; done&#x27;&lt;&#x2F;code&gt; line, to delay the service start until Minikube is actually ready to welcome traffic.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;32655&lt;&#x2F;code&gt; is my Minikube port for HTTPS.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;one-last-thing&quot;&gt;One last thing&lt;&#x2F;h3&gt;
&lt;p&gt;I needed a TLS certificate, stored as a Kubernetes secret. Of course, that secret would stay on the server. I would only reference it in my k8s files in Git.
I would eventually evaluate modern SecretOps alternatives. I only used SOPS in the past.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ll obviously skip all the TLS generation part, which ends up with a &lt;code&gt;.pem&lt;&#x2F;code&gt; and a &lt;code&gt;.key&lt;&#x2F;code&gt;. Those are common but quite tedious to generate.&lt;&#x2F;p&gt;
&lt;p&gt;Things were not over though. At this point, I was able to access my server over my local network with a simple &lt;code&gt;&#x2F;etc&#x2F;hosts&lt;&#x2F;code&gt; entry, but I wanted to be able to access my pods over the Internet.&lt;&#x2F;p&gt;
&lt;p&gt;Gitea would stay local network only.&lt;&#x2F;p&gt;
&lt;p&gt;I remembered about DynDNS a lifetime ago. I wanted to have something similar setup, and to avoid needing a static IP address from my ISP. So I decided to go with Cloudflare Tunnels.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;opening-to-the-internet&quot;&gt;Opening to the Internet&lt;&#x2F;h2&gt;
&lt;p&gt;I already had a cool domain name. Now it was about time to use it.&lt;&#x2F;p&gt;
&lt;p&gt;The plan was:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;To create the tunnel, and run &lt;code&gt;cloudflared&lt;&#x2F;code&gt; on the server,&lt;&#x2F;li&gt;
&lt;li&gt;To modify some DNS entries to redirect to Cloudflare&#x27;s Tunnel,&lt;&#x2F;li&gt;
&lt;li&gt;And to make sure traffic was effectively hitting the Tunnel, the Ingress, and eventually, the Pods&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;You can say I saw that Cloudflare &quot;Gateway Error&quot; gray page for a few hours.&lt;&#x2F;p&gt;
&lt;p&gt;Setup was relatively easy to follow. You can basically choose to create Tunnels from their dashboard, or yourself with the CLI, which I believe they call &quot;Self-Managed Tunnels&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;But I had forgotten to remove the &lt;code&gt;&#x2F;etc&#x2F;hosts&lt;&#x2F;code&gt; entry at some point. So I was quite a bi confused with the debugging.&lt;&#x2F;p&gt;
&lt;p&gt;The setup went basically like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;pacman -Ss&lt;&#x2F;span&gt;&lt;span&gt; cloudflare
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;yay -S&lt;&#x2F;span&gt;&lt;span&gt; cloudflared
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cloudflared&lt;&#x2F;span&gt;&lt;span&gt; tunnel login &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# Open a Oauth2 page and gets a token
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cloudflared&lt;&#x2F;span&gt;&lt;span&gt; tunnel create suto-tunnel &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# Yeah, that&amp;#39;s the name of my app
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cloudflared&lt;&#x2F;span&gt;&lt;span&gt; tunnel route dns suto-tunnel suto.MY_SECRET_DOMAIN.io
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; cloudflared service install &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# To create the Systemd files
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; systemctl enable cloudflared
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;sudo cloudflared service install&lt;&#x2F;code&gt; created a couple of services, mainly &lt;code&gt;cloudflared.service&lt;&#x2F;code&gt; and a timer update service which was generic enough and that I didn&#x27;t modify at all.&lt;&#x2F;p&gt;
&lt;p&gt;However, my &lt;code&gt;cloudflared.service&lt;&#x2F;code&gt; file ended up looking like this:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# cloudflared.service
&lt;&#x2F;span&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=cloudflared
&lt;&#x2F;span&gt;&lt;span&gt;After=network-online.target
&lt;&#x2F;span&gt;&lt;span&gt;After=ingress-https-forward.service
&lt;&#x2F;span&gt;&lt;span&gt;Wants=network-online.target
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;TimeoutStartSec=15
&lt;&#x2F;span&gt;&lt;span&gt;Type=notify
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;usr&#x2F;bin&#x2F;cloudflared --loglevel debug --config &#x2F;etc&#x2F;cloudflared&#x2F;config.yml tunnel run
&lt;&#x2F;span&gt;&lt;span&gt;Restart=on-failure
&lt;&#x2F;span&gt;&lt;span&gt;RestartSec=5s
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;One trivial detail: Using &lt;code&gt;create suto-tunnel&lt;&#x2F;code&gt; and &lt;code&gt;route dns&lt;&#x2F;code&gt; cloudflared subcommands would update your user&#x27;s``~&#x2F;.cloudflared&#x2F;config.yaml&lt;code&gt;. So you have to make sure your services point to the right config files, if you decided to put those into &lt;&#x2F;code&gt;&#x2F;etc&#x2F;cloudflared`, of course.&lt;&#x2F;p&gt;
&lt;p&gt;I also thought that the service journal wasn&#x27;t verbose at all, hence the &lt;code&gt;--loglevel debug&lt;&#x2F;code&gt;. I was getting crazy, not knowing if my external requests were actually hitting the tunnel, or if my DNS entries weren&#x27;t properly set up or refreshed.&lt;&#x2F;p&gt;
&lt;p&gt;I still had issues with TLS though. So CF&#x27;s default configuration ended up like this for me:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;tunnel: TUNNEL_ID
&lt;&#x2F;span&gt;&lt;span&gt;credentials-file: &#x2F;home&#x2F;makkusu&#x2F;.cloudflared&#x2F;TUNNEL_ID.json
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;ingress:
&lt;&#x2F;span&gt;&lt;span&gt;  - hostname: suto.MY_SECRET_DOMAIN.io
&lt;&#x2F;span&gt;&lt;span&gt;    service: https:&#x2F;&#x2F;localhost:443
&lt;&#x2F;span&gt;&lt;span&gt;    originRequest:
&lt;&#x2F;span&gt;&lt;span&gt;      noTLSVerify: true
&lt;&#x2F;span&gt;&lt;span&gt;  - service: http_status:404
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I basically had to end the TLS encryption to my tunnel. My browser wouldn&#x27;t accept my self-signed certificate otherwise, because of my own self-declared authority. Cloudflare&#x27;s certificate would take the relay here.&lt;&#x2F;p&gt;
&lt;p&gt;I don&#x27;t believe this is a big deal, though.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;moment-of-truth&quot;&gt;Moment of Truth&lt;&#x2F;h2&gt;
&lt;p&gt;One thing I like to do after finishing a setup just relies on pressing the power button.&lt;&#x2F;p&gt;
&lt;p&gt;You don&#x27;t know if you did everything right if you kept your session alive, but forgot to enable or restart services. The only way to know is to pull the plug.&lt;&#x2F;p&gt;
&lt;p&gt;Yeah. This step took me a few times.&lt;&#x2F;p&gt;
&lt;p&gt;I think I still got an issue to this day though, because every now and then, trying to access my server would result in the Cloudflare gateway error page, and I don&#x27;t think this is on them. I probably still have a race condition to fix, or to make sure the tunnel runs when all of its dependencies are ready, not just started.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;finishing-touches&quot;&gt;Finishing Touches&lt;&#x2F;h2&gt;
&lt;p&gt;Setting up a server is nice, but it&#x27;s even nicer to keep track of its configuration and ADRs, so I just created a repository for my server, similar to infamous &lt;code&gt;dotfiles&lt;&#x2F;code&gt;. It&#x27;s just securely stored in a Proton Drive :)&lt;&#x2F;p&gt;
&lt;p&gt;I do have a &lt;code&gt;k8s&lt;&#x2F;code&gt; folder in a few repositories, which contain app&#x27;s YAML manifests. I decided to go with Kustomize for those, because I believe it&#x27;s the simplest and the cleanest way to deploy small apps on k8s, because it uses plain YAML to generate other YAML, while Helm relies on templating and substitutions. It&#x27;s like replacing Wordpress with a static site generator, in a way.&lt;&#x2F;p&gt;
&lt;p&gt;And eventually, I&#x27;ll probably have a &quot;generic&quot; CI for my server itself, for shared services, such as PostgreSQL databases with specific versions, and some observability services too :)&lt;&#x2F;p&gt;
&lt;p&gt;Helm can be very handy though, with its existing collection of charts. But I would keep it at bay for my own apps.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s also worth mentioning that I used Claude Code from time to time, especially for generating a self-signed certificate. This definitely made this step less tedious. And since I stored my server&#x27;s general info (such as IP address, the services it runs, etc) as documentation, I was able to leverage Claude in interesting ways. This post is purely from a human, though.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrap-up&quot;&gt;Wrap-up&lt;&#x2F;h2&gt;
&lt;p&gt;So, this was quite a big chunk. What&#x27;s next?&lt;&#x2F;p&gt;
&lt;p&gt;Well.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m still undecided which one in particular is next though, as this post is pretty up-to-date with my server&#x27;s current state.&lt;&#x2F;p&gt;
&lt;p&gt;What was this guy doing all of this for again?
Oh yeah. Dev server, and training.&lt;&#x2F;p&gt;
&lt;p&gt;Well, next time, I&#x27;ll probably cover one of those topics:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Setting up ArgoCD (GitOps),&lt;&#x2F;li&gt;
&lt;li&gt;Setting up Grafana LGTM for Observability, Logs, Tracing (exciting!),&lt;&#x2F;li&gt;
&lt;li&gt;Setting up SOPS for secrets management,&lt;&#x2F;li&gt;
&lt;li&gt;Adding a new machine as a cluster node (ok, this one is definitely not next, I need to buy the hardware) (and swapping Minikube with MicroK8s?),&lt;&#x2F;li&gt;
&lt;li&gt;Server hardening? Since I do not have that many services running or ports open yet, that one may be short.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Yeah. We&#x27;ll see, we&#x27;ll see.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, see you next time.&lt;&#x2F;p&gt;
&lt;p&gt;P.S.: I didn&#x27;t include any copy of my app&#x27;s kubernetes YAML files. Those are pretty standard and would have cluttered the body of this post for little added value.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Stop using your app query builder for analytics</title>
          <pubDate>Sun, 18 Jan 2026 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20260118-stop-using-your-app-query-builder-for-analytics/</link>
          <guid>https://mbuffa.github.io/articles/20260118-stop-using-your-app-query-builder-for-analytics/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20260118-stop-using-your-app-query-builder-for-analytics/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;A few years ago (in 2022 I believe), I had a disagreement with an interviewer debriefing one of my take-home assessment. We were discussing the usage of raw SQL in a codebase, and I believe my position cost me the role (or, alternatively, the way I expressed my disagreement did).&lt;&#x2F;p&gt;
&lt;p&gt;We were basically arguing over a query that was doing a bit of filtering, grouping, and formatting data. This query took no parameter, and considering the query was used to extract analytics, I decided to go for raw SQL.&lt;&#x2F;p&gt;
&lt;p&gt;This is relatively easy to do with many frameworks, and it&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;ecto_sql&#x2F;Ecto.Adapters.SQL.html#query&#x2F;4&quot;&gt;straightforward in Elixir with Ecto&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I think I also failed at expressing stronger arguments at the time other than &quot;You don&#x27;t need the added complexity of an ORM, for a simple query without arguments.&quot; and if I recall correctly, the person I was talking to was just saying &quot;it&#x27;s safer&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;I did a bit more work related to analytics since then, and I gathered stronger arguments. I&#x27;ll keep it short, but here they are :)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;your-app-query-builder-is-another-layer-of-complexity&quot;&gt;Your app query builder is another layer of complexity&lt;&#x2F;h3&gt;
&lt;p&gt;This is literally another DSL on top of another DSL (which is, in this case, SQL).&lt;&#x2F;p&gt;
&lt;p&gt;A DSL is a system, and each system comes with some overhead, the possibility of oversights (such as N+1 queries) and bugs related to the library.&lt;&#x2F;p&gt;
&lt;p&gt;It also comes with limitations. I recently saw that a PHP ORM didn&#x27;t have support for the &lt;code&gt;WHERE x OR Y&lt;&#x2F;code&gt; syntax for its query builder. I wouldn&#x27;t be surprised if PostgreSQL&#x27;s &lt;code&gt;with&lt;&#x2F;code&gt; statements weren&#x27;t supported in some libraries even to this day.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;sql-is-the-domain-language-for-data-queries&quot;&gt;SQL is the domain language for data queries&lt;&#x2F;h3&gt;
&lt;p&gt;A query builder also forces you to &lt;code&gt;think&lt;&#x2F;code&gt; using its grammar and semantics, which may be very different than the underlying database language.&lt;&#x2F;p&gt;
&lt;p&gt;Your Database Administrator or DevOps may not know this language, which would be a problem if they had to debug those by themselves.&lt;&#x2F;p&gt;
&lt;p&gt;And finally, you may eventually have or want to switch libraries, or languages, and you would have to port your queries over.&lt;&#x2F;p&gt;
&lt;p&gt;Arguably, you could also have or want to switch to another database, with its own DSL. But I assume this would be less likely to happen, at least for a company&#x27;s typical &quot;core&quot; records (eg. sales, customers, ...).&lt;&#x2F;p&gt;
&lt;h3 id=&quot;you-can-do-better-than-writing-analytics-inside-your-codebase&quot;&gt;You can do better than writing analytics inside your codebase&lt;&#x2F;h3&gt;
&lt;p&gt;I recently worked on a project where we were building a dashboard, with analytics queries written with our ORM.&lt;&#x2F;p&gt;
&lt;p&gt;The flow went this way:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A developer would write those queries and merge them to the trunk,&lt;&#x2F;li&gt;
&lt;li&gt;I would try to use them, write tests to check those were valid,&lt;&#x2F;li&gt;
&lt;li&gt;Potentially reported bugs, and had to wait a bit before the fix came up,&lt;&#x2F;li&gt;
&lt;li&gt;Had to implement various export modules, without knowing if the output was correct for the business,&lt;&#x2F;li&gt;
&lt;li&gt;The person doing the QA would report to me, and I would then have to convince the person who wrote the queries that there was a problem there,&lt;&#x2F;li&gt;
&lt;li&gt;I would then have to adapt my modules to the potentially new format, and adapt all of my tests.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This was totally uneffective. A lot of those queries weren&#x27;t even tested, and the debugging was painful and slow.&lt;&#x2F;p&gt;
&lt;p&gt;Arguably, some of the things that went wrong could have been avoided by having just one developer do the whole job.&lt;&#x2F;p&gt;
&lt;p&gt;But I think the best course of action would have been to do it this way:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Take the time to spin up a &lt;a href=&quot;https:&#x2F;&#x2F;www.metabase.com&#x2F;&quot;&gt;Metabase&lt;&#x2F;a&gt; instance (or similar),&lt;&#x2F;li&gt;
&lt;li&gt;Write queries, &lt;strong&gt;and&lt;&#x2F;strong&gt; validate them on a production replica,&lt;&#x2F;li&gt;
&lt;li&gt;Validate the output with the QA team,&lt;&#x2F;li&gt;
&lt;li&gt;Implement a client that would query Metabase&#x27;s API,&lt;&#x2F;li&gt;
&lt;li&gt;Implement the export modules.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Boom. Smooth.&lt;&#x2F;p&gt;
&lt;p&gt;And this isn&#x27;t less safe. Arguably, a bit longer to setup, and that Metabase client may have to be implemented, but this would have been so easier to debug.&lt;&#x2F;p&gt;
&lt;p&gt;Thank you for reading me. Please let me know what you think.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: LiveView + Stripe + Mobile</title>
          <pubDate>Thu, 18 Dec 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20251218-elixir-live-view-stripe-mobile/</link>
          <guid>https://mbuffa.github.io/articles/20251218-elixir-live-view-stripe-mobile/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20251218-elixir-live-view-stripe-mobile/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;I recently had to integrate Stripe into an existing LiveView application used by a few customers in production. I was already quite accustomed to Stripe, but it was a while since I implemented a flow from frontend to backend, and the first time I had to do it inside a LiveView app, moreover, an app receiving async events from another service through a message broker.&lt;&#x2F;p&gt;
&lt;p&gt;There were a few difficulties that appeared along the way, and I wanted to register and share them to anyone who would eventualy have to work on this kind of topics. Or to my future self.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;setup&quot;&gt;Setup&lt;&#x2F;h2&gt;
&lt;p&gt;I won&#x27;t be revealing too many details about the project itself, but the app was basically using LiveView and receiving async events from another service, Stripe.js and a backend client to communicate with Stripe, as well as a custom Stripe form built with Stripe Elements. A couple of hooks from myself would be added to initialize the Stripe Elemments correctly and handle the back-and-forth between backend and frontend. Stripe uses both public and secret keys, because Stripe.js is only allowed to do a subset of the things your backend will be able to do, plus a few other things that only a frontend is supposed to do, like submitting card details to Stripe.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;websockets-and-mobile&quot;&gt;WebSockets. And Mobile.&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s start with the latest and the most critical issue I encountered, since the app was already live when it was discovered, and had to be patched quickly.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;websockets&quot;&gt;WebSockets&lt;&#x2F;h3&gt;
&lt;p&gt;LiveView relies on WebSockets, an active connection between a browser and a server that allows sending data both ways. LiveView uses it to send events to both sides, as well as DOM updates.&lt;&#x2F;p&gt;
&lt;p&gt;One thing I knew was that LV does not handle slow clients very well, and even with a small page, latency can really kill your user experience, making your whole application very laggy and losing state with too much back-and-forth between your backend and frontend. This is not the end of the world though, and you can easily workaround this by debouncing your UI elements (eg. you do not send immediate key stroke events from your inputs), or use more simple JS-based UI components for everything that doesn&#x27;t need to be tracked by the backend. I covered the former in a previous article, and I believe DaisyUI would be the perfect fit for the latter.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;and-mobile&quot;&gt;And Mobile&lt;&#x2F;h3&gt;
&lt;p&gt;But the thing is that LiveView is also very affected by the unstable nature of mobile networks, so I knew I had some mitigation to put in place if users would wish, for example, to be able to use the app in, let&#x27;s say, public transports.&lt;&#x2F;p&gt;
&lt;p&gt;What I didn&#x27;t know however, was that WebSockets can be very, very quickly killed by just swiping to another application, on older devices, every time. And that is probably aggravated by energy saving mode.&lt;&#x2F;p&gt;
&lt;p&gt;So, what if you&#x27;re on a payment form, entering your details, and switching to your banking app to authorize the transaction?&lt;&#x2F;p&gt;
&lt;p&gt;Boom.&lt;&#x2F;p&gt;
&lt;p&gt;The page would reload, and the user would have to enter all their details again, even though they had already paid. And because of some technical choices made, it was impossible to retrieve the user &quot;cart&quot;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;how-to-fix-this&quot;&gt;How to fix this&lt;&#x2F;h3&gt;
&lt;p&gt;The most immediate and reliable way to fix this issue was to implement a frontend cache using the browser&#x27;s Session Storage. When going back to their browser, LiveView&#x27;s JS would timeout, reconnect and create a new process (representing the LiveView) on the server. State would be cleared, but the cache stored in the Session Storage would be picked up, so that an additional Javascript hook would be able to send a message to the backend, do some transactional stuff, and redirect the user accordingly.&lt;&#x2F;p&gt;
&lt;p&gt;It took me a bit (two full days) to get this right and to &quot;integrate&quot; that cache resolution in a reasonable way, making sure the UI wouldn&#x27;t allow the user to take any additional action, and to make sure all edge cases were covered.&lt;&#x2F;p&gt;
&lt;p&gt;LiveView is great, but since it stores the initial state in the backend, I&#x27;m not sure it is the perfect fit for such an app, even though it probably simplifies things too when you have to also receive messages from a broker and propagate it to a UI. Also, admittedly, I know a couple of &quot;regular&quot; (React) frontend developers that wouldn&#x27;t want to bother with mobile browsers, and redirect users to a native mobile app, so I think this is not a liked topic overall.&lt;&#x2F;p&gt;
&lt;p&gt;If I had to rewrite or adapt it, I would probably try to be the most &quot;low tech&quot; as possible for this, with the possibility of replacing the sensitive parts of the app with plain Phoenix templates, and, maybe, Inertia + React.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;get-me-hooked&quot;&gt;Get me hooked&lt;&#x2F;h2&gt;
&lt;p&gt;As a reminder, a basic LiveView hook looks like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;js&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-js &quot;&gt;&lt;code class=&quot;language-js&quot; data-lang=&quot;js&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;var &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;hook &lt;&#x2F;span&gt;&lt;span&gt;= {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;mounted&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;&#x2F;&#x2F; You can execute some code here.
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;handleEvent&lt;&#x2F;span&gt;&lt;span&gt;(&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;event&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;, (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;payload&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;=&amp;gt; &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;&#x2F;&#x2F; You can send events back to the backend:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;&#x2F;&#x2F; this.pushEvent(&amp;quot;event-response&amp;quot;, {})
&lt;&#x2F;span&gt;&lt;span&gt;        })
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is a &quot;glue&quot;, and it is essential when you have to send messages between frontend and backend and when you need some form of JS interoperability (calling the browser API).&lt;&#x2F;p&gt;
&lt;p&gt;But you have to keep in mind that your HTML gets rendered progressively, once your &lt;code&gt;mount&#x2F;3&lt;&#x2F;code&gt; callback in your backend has already been called once. So, If you&#x27;re, for example, sending a request from a server and waiting for the response to send it to your frontend using &lt;code&gt;push_event&lt;&#x2F;code&gt;, you may face a race condition situation: Your LiveView pushes an event, but your hook isn&#x27;t ready to handle it yet, and it&#x27;s lost into abyss.&lt;&#x2F;p&gt;
&lt;p&gt;There are several things you can do to avoid that.&lt;&#x2F;p&gt;
&lt;p&gt;First, you could try to place your hook &quot;upper&quot; in your templates. If your hook isn&#x27;t tied to a specific page, that may be completely fine.&lt;&#x2F;p&gt;
&lt;p&gt;Another thing I tried to do was to keep the hook where it was supposed to be, and added a &quot;root&quot; event listener on top of my Javascript, which would intercept the message, and try &quot;pass&quot; the event to the hook using a Promise, with a retry mechanism that would keep trying until the hook was ready.&lt;&#x2F;p&gt;
&lt;p&gt;I felt very smart at first, but this was a very overkill, unreliable, and pretty stupid piece of code that I eventually just replaced with DOM.&lt;&#x2F;p&gt;
&lt;p&gt;As a general advice, I think it is much better to rely on LiveView&#x27;s capability to track changes on socket assigns, and to pass the relevant arguments you want to pass to your components by using &lt;code&gt;data-&lt;&#x2F;code&gt; attributes, or equivalent. For instance:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;html&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-html &quot;&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;&amp;lt;!-- LiveView --&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;div&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;.LiveComponent &#x2F;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;.LiveComponent&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &amp;lt;.LiveComponent &#x2F;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;&amp;lt;!-- You want to pass one of the LV assigns here. --&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&#x2F;.LiveComponent&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;.LiveComponent &#x2F;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;div&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You can just pass data using &lt;code&gt;data-&lt;&#x2F;code&gt; attributes. That&#x27;s what they&#x27;ve been made for. You should use &lt;code&gt;push_event&lt;&#x2F;code&gt; only if you don&#x27;t want the target component to not re-render completely.&lt;&#x2F;p&gt;
&lt;p&gt;And this of course applies to events your LiveView would receive from Phoenix PubSub: just update your socket assigns, do not push an event while your DOM may not be ready.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;stripe-specificities&quot;&gt;Stripe specificities&lt;&#x2F;h2&gt;
&lt;p&gt;One final issue I wanted to mention is that Stripe seems to set a couple of safety measures in place to protect the end-user. When you use Stripe Elements, you basically end up with one &lt;code&gt;&amp;lt;iframe&amp;gt;&lt;&#x2F;code&gt; for each form element you include (if you&#x27;re not using a prebuilt form), and Stripe.js uses promises to make the communication happen between your Javascript, and the iframe&#x27;s Javascript. Those promises can fail if you happen to, for example, put a loder modal with a high Z index.&lt;&#x2F;p&gt;
&lt;p&gt;If you want to warn your user that a background processing is taking place, then you probably want to disable and alter the submit button, and avoid modals entirely.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: Why your LiveViews `mount&#x2F;3` shall be minimal and fast</title>
          <pubDate>Mon, 24 Nov 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20251124-elixir-live-view-mount-blocking-ops/</link>
          <guid>https://mbuffa.github.io/articles/20251124-elixir-live-view-mount-blocking-ops/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20251124-elixir-live-view-mount-blocking-ops/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;There&#x27;s one thing that you may do when developping your first LiveView apps (or developping applications in the early days of LV) that may have important consequences in production, or even during development, which may also become a bit hard to track down.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;phoenix_live_view&#x2F;Phoenix.LiveView.html&quot;&gt;LiveView documentation&lt;&#x2F;a&gt; is excellent and easy to read, and there&#x27;s a good paragraph on async operations. But it may not stress out enough how having blocking operations in your &lt;code&gt;mount&#x2F;3&lt;&#x2F;code&gt; callback may be a very terrible idea.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;your-page-lifecycle&quot;&gt;Your page lifecycle&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;mount&#x2F;3&lt;&#x2F;code&gt; is called two times: on your first page render, and another time when your socket gets connected, initially. Also, if your frontend disconnects and reconnects, &lt;code&gt;mount&#x2F;3&lt;&#x2F;code&gt; will be called again.&lt;&#x2F;p&gt;
&lt;p&gt;So, let&#x27;s say you have a typical CRUD app, with a query that would fetch records on the index action, and doing that query in &lt;code&gt;mount&lt;&#x2F;code&gt;. Almost sounds harmless, right?&lt;&#x2F;p&gt;
&lt;p&gt;But it would actually have a couple of effects.&lt;&#x2F;p&gt;
&lt;p&gt;After a successful deployment, with a substantial amount of users connected, their LiveViews would try to reconnect to the newly deployed backends, may take a while to reconnect, freeze the UI meanwhile, or even end up in a timeout state. Also, navigations between pages would be much slower and probably noticeable.&lt;&#x2F;p&gt;
&lt;p&gt;Also, in development, you would eventually trigger the code reloader, that would in turn kill and reset your current LiveView(s). potentially depleting your Ecto pool. It doesn&#x27;t take more than a few tabs open or several active LiveViews to trigger this situation with the default setup of 10 connections.&lt;&#x2F;p&gt;
&lt;p&gt;Bottom line is: that particular callback should always be minimal, and you should always try to do things asynchronously as much as psosible. &lt;code&gt;start_async&#x2F;3&lt;&#x2F;code&gt; and &lt;code&gt;assign_async&#x2F;3&lt;&#x2F;code&gt; are excellent ways to help you do that. And to be fair, this is not a nice to have. It should be mandatory for all production apps and as such, treated as a high priority flaw to address.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: Rate limit your LiveView forms</title>
          <pubDate>Mon, 17 Nov 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20251117-elixir-live-view-debounce/</link>
          <guid>https://mbuffa.github.io/articles/20251117-elixir-live-view-debounce/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20251117-elixir-live-view-debounce/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;Not so long ago, on a Friday morning, while I was peacefully making some coffee and preparing for a relaxed day after weeks of crunch, I received a strange message that would eventually transform this day into a totally different experience.&lt;&#x2F;p&gt;
&lt;p&gt;The feedback was about a specific Live View form that was behaving weirdly, and the phenomenon was supposedly new: using the form was causing some data to be lost, multiple selected items would be erased, and so on.&lt;&#x2F;p&gt;
&lt;p&gt;I immediately thought about a bad connectivity issue but couldn&#x27;t reproduce the issue on our test environment, even with the integrated browser throttling tools.&lt;&#x2F;p&gt;
&lt;p&gt;But I eventually made it. With a VPN, connected to servers far away from my servers&#x27; location.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;issue&quot;&gt;Issue&lt;&#x2F;h2&gt;
&lt;p&gt;Simply put, the culprit was the form itself, and how it was handling validation: on each key stroke. That was causing issues when the user experienced some connection latency (even with a fast connection, because of the delay that may happen between HTTP calls), and so LiveView&#x27;s frontend part was overloading the backend, causing various behaviors, such as a flashing UI, unresponsive widgets, or even lost data.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;solution&quot;&gt;Solution&lt;&#x2F;h2&gt;
&lt;p&gt;I remembered encountering a similar situation with React, and this is honestly Frontend Development 101: you have to throttle or debounce your validations, and you don&#x27;t need to execute them while the user isn&#x27;t done typing their name or their phone number anyway.&lt;&#x2F;p&gt;
&lt;p&gt;Since its early days, &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;phoenix_live_view&#x2F;1.1.17&#x2F;bindings.html#rate-limiting-events-with-debounce-and-throttle&quot;&gt;LiveView provides an easy way to do that&lt;&#x2F;a&gt;. &lt;code&gt;phx-debounce&lt;&#x2F;code&gt; allows passing an integer value representing milliseconds, or &quot;blur&quot;, so that you can decide if you&#x27;ll trigger validation once the input loses focus, or after a varying period of time. &lt;code&gt;phx-throttle&lt;&#x2F;code&gt; does the same thing, except it emits an event on the first change before the rate limit.&lt;&#x2F;p&gt;
&lt;p&gt;So, nothing revolutionary here, but you&#x27;ll probably want to check and optimize your LiveViews (and your components, and &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nkezhaya&#x2F;live_phone&#x2F;pull&#x2F;169&quot;&gt;libraries&lt;&#x2F;a&gt;) &lt;em&gt;before&lt;&#x2F;em&gt; it gets used by thousands of people.&lt;&#x2F;p&gt;
&lt;p&gt;Some days just make you feel you&#x27;re the cop being shot two days before retirement.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Blog: Hacking my Linux server at home - Part 1</title>
          <pubDate>Mon, 10 Nov 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20251110-blog-server-hacking-part-one/</link>
          <guid>https://mbuffa.github.io/articles/20251110-blog-server-hacking-part-one/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20251110-blog-server-hacking-part-one/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;This summer, I went back to hacking my own server at home for fun and educational purposes, and I wanted to start a blog to share the goals, the highs and lows, the ruminations and the moments of great fulfillment.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;goals&quot;&gt;Goals&lt;&#x2F;h2&gt;
&lt;p&gt;My goals with this small project are:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;To have my own software &quot;forge&quot; and Kubernetes cluster, on which to deploy my pre-alpha apps; basically, I want a cheap staging environment.&lt;&#x2F;li&gt;
&lt;li&gt;To get back to sysadmin and devops and tinker on some software I really want to try.&lt;&#x2F;li&gt;
&lt;li&gt;To have a cheaper, and, I hope, more reliable alternative to some online providers.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-hardware&quot;&gt;The Hardware&lt;&#x2F;h2&gt;
&lt;p&gt;From, maybe, 2009 to 2014, I managed a small server at my parents house. It wasn&#x27;t doing much, and I had picked a cubic Lian-Li case of a smaller frame (ITX or micro-ATX, I don&#x27;t remember exactly which one that was). This server would act as a file storage server, a Bittorrent client, and, occasionally, a Minecraft server, although the performance wasn&#x27;t that great.&lt;&#x2F;p&gt;
&lt;p&gt;This server was made a bit redundant when I finally acquired a (Synology) NAS, which I still use to this day, with two 2TB hard disk drives mounted in RAID-1. Now that I think of it, those disks may need to be replaced, but RAID-1 ensures a minimum level of security.&lt;&#x2F;p&gt;
&lt;p&gt;For my new setup, I decided to go for a used Thinkcentre small PC. This may be the first time I buy used hardware, as I usually want my devices to be spot-free, especially for mouses, keyboards, cases and core components (like CPUs and GPUs), but I figured I wouldn&#x27;t mind this much for a server, especially considering the fact that it came with a brand new NVME (I bought from a reseller). Also, I favored that option rather than buying extra cheap hardware from Aliexpress, or full-blown $3000 rack servers. I do not quite need this war equipment just yet :)&lt;&#x2F;p&gt;
&lt;p&gt;I would have went for an ARM CPU if I have had the possibility, but this wasn&#x27;t really in the same budget target (I paid roughly 180 EUR for the Thinkcentre). That Ryzen tech will be good enough for a while.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-software&quot;&gt;The Software&lt;&#x2F;h2&gt;
&lt;p&gt;I went for Arch Linux for the OS. I used Debian, then Ubuntu for a couple of years before switching to Gentoo, and finally Arch around 2009. Arch combines the benefits of a rolling release OS, without having the need to recompile all of your OS when glibc gets upgraded (hello Gentoo).&lt;&#x2F;p&gt;
&lt;p&gt;Using a rolling release OS might not be wise for a server, but I had a few issues with migrating &quot;regular&quot; setups from one LTS version to another one, and in my experience, the Arch Linux website always mentions breaking changes, so you can almost always repair those small issues before shutting down your machine.&lt;&#x2F;p&gt;
&lt;p&gt;There have been a couple of new distributions more recently though. I typically like to use Alpine a lot for containers images, but I didn&#x27;t believe its UX would be that great for a &quot;long-lived&quot; server.&lt;&#x2F;p&gt;
&lt;p&gt;There also have been a couple of Arch derivatives that popped up, but I&#x27;d rather tinker on user-level software rather than wondering why my Kernel stopped working for no reason. Also, Arch tends (or tended?) to be &lt;em&gt;minimalistic&lt;&#x2F;em&gt;, meaning that packaged software often do not vary that much compared to tarballs distributed by the software itself. Also, Arch&#x27;s wiki has the reputation to be one of the best in the Linux universe.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;setting-things-up&quot;&gt;Setting things up&lt;&#x2F;h2&gt;
&lt;p&gt;So, after creating a bootable USB drive and connecting my small PC with a keyboard, I ended up following the Arch Handbook I followed a decade ago. It went smooth, apart from a tiny obstacle I encountered quite early, at the bootloader prompt.&lt;&#x2F;p&gt;
&lt;p&gt;Around 2010, if I remember correctly, the Linux kernel gained framebuffer support for the TTY. This meant support for wide resolutions, instead of the legacy default (which I believe was 800x600 pixels). This made the terminal look much better, but it also made it completely unreadable for me.&lt;&#x2F;p&gt;
&lt;p&gt;A simple solution for this issue is to simply edit the bootloader command with a shortcut (was it &lt;code&gt;Tab&lt;&#x2F;code&gt; or &lt;code&gt;;&lt;&#x2F;code&gt; or &lt;code&gt;,&lt;&#x2F;code&gt;?) and append &lt;code&gt;video=800x600&lt;&#x2F;code&gt; to the kernel arguments. This wasn&#x27;t pretty on a 21:9 screen, but at least I could read.&lt;&#x2F;p&gt;
&lt;p&gt;The initial setup was pretty straightforward, disk partitioning was kept very simple, with a root and swap partition, along the usual GPT partition that you have to setup to boot.
I followed the Arch handbook, but also asked a LLM to make me a summary for setting up the network, correctly set up locales, things like that. I&#x27;m not quite used to the newer &lt;code&gt;ip addr&lt;&#x2F;code&gt; commands yet (I was used to &lt;code&gt;ipconfig&lt;&#x2F;code&gt;) and I wanted to see how a LLM would fare. It went well.&lt;&#x2F;p&gt;
&lt;p&gt;I quickly finished the initial setup, which was involving:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Having the server run on both WLAN and Ethernet, which a permanent DHCP-attributed IP address.&lt;&#x2F;li&gt;
&lt;li&gt;Having a SSH server up and running.&lt;&#x2F;li&gt;
&lt;li&gt;Having a Gitea server to host my most &lt;em&gt;precious&lt;&#x2F;em&gt; source codes.&lt;&#x2F;li&gt;
&lt;li&gt;Having a PostgreSQL database server for my projects (and Gitea) accessible on my local network.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I won&#x27;t paste all the commands I used here, but the setup went pretty well. You may not know Gitea: this is an alternative to Gitlab, written in Go. It is still a bit less mature than Gitlab, but it consumes much less memory, is faster, and almost 100% compatible with Github Actions workflow files. Nice! I&#x27;ll be able to run both Github and Gitea CIs and compare :)&lt;&#x2F;p&gt;
&lt;p&gt;The PostgreSQL setup was pretty straightforward as well, even though I&#x27;m not a bit fan of using a database installed with a system package: when you update that package, you typically have to migrate your owl database t othe new format. You probably want to dump your old database before updating then, but this is a bit tedious to do.&lt;&#x2F;p&gt;
&lt;p&gt;Arch provides a legacy package for this purpose, eg. when upgrading from PG 17 to 18, you would be able to install PG 17 binaries in your system to use PG&#x27;s internal migration tool.&lt;&#x2F;p&gt;
&lt;p&gt;But, to be honest, I&#x27;ll eventually run Postgres in its own environment eventually, probably in a container so that I can swap binaries at will, with a Docker volume exposing the data folder that I&#x27;ll be able to migrate easily. This will prevent me from breaking my database when running system updates.&lt;&#x2F;p&gt;
&lt;p&gt;With all that setup, I was able to start pushing my projects to my server. In my next post, I&#x27;ll detail how I configured my own Gitea CI to be able to run tests, and to deploy on my Kubernetes cluster using Minikube :)&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>LLM: Stop using Claude Code</title>
          <pubDate>Fri, 07 Nov 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20251107-stop-using-claude-code/</link>
          <guid>https://mbuffa.github.io/articles/20251107-stop-using-claude-code/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20251107-stop-using-claude-code/">&lt;h2 id=&quot;be-aware&quot;&gt;Be aware&lt;&#x2F;h2&gt;
&lt;p&gt;Stop using Claude Code.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve discovered how to transcend your daily developer experience. How?&lt;&#x2F;p&gt;
&lt;p&gt;With Jean-Claude Code. The only one capable of high-kicking your features into shape.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s a way to demystify your worst debugging sessions, add a personalized touch to your audits, and why not, further enhance the experience with voice synthesis.&lt;&#x2F;p&gt;
&lt;p&gt;But, jokes aside, I wanted to share my feelings about using an LLM as a developer.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve been using Claude Code for several months, and I used Copilot since its beta, before parting ways with it a few years later.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;github-copilot&quot;&gt;Github Copilot&lt;&#x2F;h2&gt;
&lt;p&gt;Copilot had the merit of significantly speeding up the writing of boilerplate code - the basic, verbose, and not technically critical parts of your projects. It had a strong tendency to invent very practical functions that were absolutely non-existent. Magic code, and often very bad code.&lt;&#x2F;p&gt;
&lt;p&gt;I ended up disabling multi-line suggestions to only keep the current line, as the rest was often way off the mark. Then I eventually stopped using it completely, returning only to the tools provided for my language, my framework, my IDE. The experience lasted roughly two years.&lt;&#x2F;p&gt;
&lt;p&gt;And then, this year, I tried Claude Code, curious but somewhat reluctant given the wave of vibe coding combined with my bad memories of (Github) Copilot.&lt;&#x2F;p&gt;
&lt;p&gt;Spoiler: the experience is conclusive.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;claude-code&quot;&gt;Claude Code&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s be clear. The current model (Sonnet 4.5) is far from perfect.
It makes mistakes.
It sometimes takes very big shortcuts.
Gets the diagnosis wrong.&lt;&#x2F;p&gt;
&lt;p&gt;Or simply deletes tests I just asked for, because it deems they require too many modifications to work. Hold on a minute. You could have transformed these integration assertions into a series of unit assertions.&lt;&#x2F;p&gt;
&lt;p&gt;It often requires multiple back-and-forths to get the perfect solution.&lt;&#x2F;p&gt;
&lt;p&gt;But for the rest...&lt;&#x2F;p&gt;
&lt;p&gt;Claude Code is capable, with provided context, precise instructions, and a relatively clean codebase, of proposing relevant evolutions, detailed audits of your business code or your test suite, and mentally relieving you on many subjects. A last-minute request, trivial but impactful, with several pieces here and there? Much simpler to handle, rather than searching for occurrences and risking forgetting some.&lt;&#x2F;p&gt;
&lt;p&gt;The UX that a dedicated tool like Claude Code offers is excellent: it doesn&#x27;t invade your space, doesn&#x27;t bother you every second, and forces you to review its suggestions as they come. Useful and pleasant code review, you say?&lt;&#x2F;p&gt;
&lt;p&gt;Claude Sonnet is one of the best pair programming assistants you can use, a wise-novice, brilliant but naive, who may not know the specifics of your business needs, and who won&#x27;t always be the expert in the situation, but who will know how to use your documentation, your ADRs, your fine-grained instructions and your discipline to produce quality work. And all of this, without imposed biological rhythms.&lt;&#x2F;p&gt;
&lt;p&gt;I also think that using this kind of tool is excellent for highlighting cognitive biases and communication patterns, to adopt a more neutral and assertive structure. Directive (paternalistic) communication with an erroneous diagnosis or guidance toward a suboptimal solution will provide mediocre results. Conversely, defining a problem, proposing a diagnosis, having it validated or invalidated, and formulating hypotheses will push the model to consider the problem as a whole, to think outside the box (un-framing) and to propose alternatives to ultimately provide better results.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;are-we-all-screwed-yet&quot;&gt;Are we all screwed yet?&lt;&#x2F;h2&gt;
&lt;p&gt;In short, even though I haven&#x27;t used MCP yet, I wanted to take stock and answer some questions I regularly see coming up.&lt;&#x2F;p&gt;
&lt;p&gt;Is it still necessary to learn to code in 2025? More than ever. Generative AI is already transforming the work of the individual contributor to bring it closer to that of a decision-maker or an architect, but you will always need the best possible expertise to use it and to understand what you read.&lt;&#x2F;p&gt;
&lt;p&gt;Will AI sign the death warrant of developers? I don&#x27;t think so. For me, it&#x27;s undeniable that there will be repercussions on the job market, but not necessarily more than the consequences resulting from rising interest rates and the corporate financing crisis. There will also always be a need for a human to take responsibility for downtime, a regression, or a failed exchange leading to a client&#x27;s departure (if we go beyond the scope of development).&lt;&#x2F;p&gt;
&lt;p&gt;On the other hand, the opportunities for solopreneurs and very small teams seem immense. As long as we show discipline. And as long as subscription prices don&#x27;t go through the roof.&lt;&#x2F;p&gt;
&lt;p&gt;Please feel free to share your thoughts on the subject :)&lt;&#x2F;p&gt;
&lt;p&gt;Disclaimer: This article is purely hand-written, but was translated from French to English using a LLM.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Management: Burn out your team in six months</title>
          <pubDate>Tue, 26 Aug 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20250826-burn-out-your-team-in-six-months/</link>
          <guid>https://mbuffa.github.io/articles/20250826-burn-out-your-team-in-six-months/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20250826-burn-out-your-team-in-six-months/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;After more than a decade of software development in professional contexts, I&#x27;ve seen numerous behaviors in the teams I have worked in or have worked with, sometimes directly experiencing some of them with my CEOs, CTOs, engineering managers or tech leads.&lt;&#x2F;p&gt;
&lt;p&gt;The patterns I will describe do apply to software development teams, but I believe they do apply to any work environment that involves management and teams, or even business to business relationships. I&#x27;ll give a lot of examples centered around software engineering though, to avoid beeing too abstract.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;disclaimer&quot;&gt;Disclaimer&lt;&#x2F;h2&gt;
&lt;p&gt;Writing this article addresses two needs:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The need to put some thoughts on paper and stop thinking about them, and,&lt;&#x2F;li&gt;
&lt;li&gt;Leverage this as an opportunity to become a better leader or manager myself; experiencing and noticing bad behaviors is as instructive as reading a training book, and I&#x27;m sure I demonstrated some of those behaviors myself.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Being aware of issues is the best way to detect, avoid or fix them in the future. And no, I&#x27;m not quoting Thufir Hawat :-)&lt;&#x2F;p&gt;
&lt;p&gt;Also, this is absolutely not a critique against my current employer. I&#x27;m also not targetting individuals themselves, but individual behaviors that can hurt productivity or mental health. Finally, my opinions are mine and do not reflect any third parties&#x27; opinions I have or currently am working with.&lt;&#x2F;p&gt;
&lt;p&gt;Lastly, this will be a mixed bag of leadership and management issues.&lt;&#x2F;p&gt;
&lt;p&gt;So, now that the frame has been set, how do you burn your team in six months? Where do you start?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-guide-to-burn-out&quot;&gt;A guide to burn-out&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;planning&quot;&gt;Planning&lt;&#x2F;h3&gt;
&lt;h4 id=&quot;drowning-your-team-under-hours-of-pointless-meetings-and-reportings&quot;&gt;Drowning your team under hours of pointless meetings and reportings&lt;&#x2F;h4&gt;
&lt;p&gt;One of the best things you can do is to schedule a lot of meetings. Bonus points for stand ups that last 45 minutes. Bonus point if you&#x27;re a slow speaker that never pauses, preventing others from reacting. Bonus point if you spend a lot of time talking about this house in the countryside you&#x27;re fixing.&lt;&#x2F;p&gt;
&lt;p&gt;Even better: schedule loose daily meetings, with no specific beginning or end or topic, and make others adapt to your schedule, so that they cannot start focusing on their own work. And take your personal phone calls during those meetings.&lt;&#x2F;p&gt;
&lt;p&gt;Try to schedule daily reportings, such as KPIs for Sales. Bonus point if they have to reach the tech team to get their numbers. Bonus point if they spend more than two hours a day making slides for the next day.&lt;&#x2F;p&gt;
&lt;p&gt;Meetings should be short, have a purpose, a specific start and end time, and be organised between teams that can take actions to solve issues. There&#x27;s no point in putting tech performers in sales meetings 30 minutes a day every day.&lt;&#x2F;p&gt;
&lt;p&gt;Your team shouldn&#x27;t take 25% or 40% just making reports.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;giving-weak-instructions-having-high-expectations&quot;&gt;Giving weak instructions, having high expectations&lt;&#x2F;h4&gt;
&lt;p&gt;Whether or not you&#x27;re a fan of AGILE or KANBAN, your work will be divided in small units of work, and whether or not you call them tickets or something else, any unit of work must &lt;em&gt;at least&lt;&#x2F;em&gt; feature a short description about &lt;strong&gt;what&lt;&#x2F;strong&gt; must be done. Well-made acceptance criteria for features are even better, because they describe a context, an event and an expected result.&lt;&#x2F;p&gt;
&lt;p&gt;Giving enough context and instructions can be very time consuming. In that case, the person in charge of this task can submit a draft for what they&#x27;re going to do, and request comments from their manager before starting the task. It can be even better this way, because the performer can inspect what&#x27;s already there and draft specs more accurately.&lt;&#x2F;p&gt;
&lt;p&gt;So, what&#x27;s the worst thing to do here?&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Write empty tasks with vague titles, or scratch &quot;Build a Back-Office&quot; on a napkin.&lt;&#x2F;li&gt;
&lt;li&gt;Ignore review requests on business and technical specs.&lt;&#x2F;li&gt;
&lt;li&gt;Use work review to complain that X or Y feature ie missing.&lt;&#x2F;li&gt;
&lt;li&gt;Use work review to question the reason behind this task.&lt;&#x2F;li&gt;
&lt;li&gt;Put the responsibility on the performer for the delay.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;control&quot;&gt;Control&lt;&#x2F;h3&gt;
&lt;h4 id=&quot;becoming-the-bottleneck-of-your-own-team&quot;&gt;Becoming the bottleneck of your own team&lt;&#x2F;h4&gt;
&lt;p&gt;Ask to be the center of every decision your team will make, and whenever possible, do it for external teams as well. Make your designer and product team require your validation for any tiny update in the design system. Do the same for the marketing team and the emails design. Consider you&#x27;re the only person able to do the job correctly.&lt;&#x2F;p&gt;
&lt;p&gt;Hire people to do a specific tasks, but don&#x27;t let them do it autonomously.&lt;&#x2F;p&gt;
&lt;p&gt;Use your veto on decisions you don&#x27;t like, and make up excuses for it.&lt;&#x2F;p&gt;
&lt;p&gt;Ask for systematic code review on every pull request, even though you work in a startup and have to ship things quickly.&lt;&#x2F;p&gt;
&lt;p&gt;Get yourself overwhelmed and delay other&#x27;s work because you do not have time to do everything.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;attitude&quot;&gt;Attitude&lt;&#x2F;h3&gt;
&lt;h4 id=&quot;not-following-your-own-rules&quot;&gt;Not following your own rules&lt;&#x2F;h4&gt;
&lt;p&gt;Theere is a book called &quot;The Art of War&quot; from Sun Tzu. It is very short and quite easy to read, and often quoted in personal development lectures. It is sometimes also mocked because, as some people say, it sometimes state the obvious, such as &quot;Don&#x27;t let your men starve&quot;, or statements like this.&lt;&#x2F;p&gt;
&lt;p&gt;This is &lt;strong&gt;wrong&lt;&#x2F;strong&gt;. No matter how often a subject will be discussed, nothing is ever too obvious. And there&#x27;s a specific teaching from the book that applies to any leader: leaders lead by example.&lt;&#x2F;p&gt;
&lt;p&gt;And they also make sure their men are fed, and they themselves eat last, but this is not a lecture about charisma :-)&lt;&#x2F;p&gt;
&lt;p&gt;In a management context, this means that any rule you force your team to follow, you have to follow it yourself.&lt;&#x2F;p&gt;
&lt;p&gt;You require code review on any pull request that they will open? Fine. Then at least open a pull request for your own work too. Do not push directly on the main branch, break the CI and then complain to them that their pull request &quot;broke the tests&quot;. If you do not have a developer role, this, of course, does not apply to you.
But being a CTO doesn&#x27;t erase the responsibilities of a Developer role when you do developer tasks.&lt;&#x2F;p&gt;
&lt;p&gt;You allow yourself to work remotely? Fine, as long as it applies to your team too. Do not schedule bullshit meetings at 7PM in the office, while you&#x27;re baby-sitting your kid on your lap, half listening to a report that you might as well read yourself.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;ignoring-other-people-s-time-work-or-input&quot;&gt;Ignoring other people&#x27;s time, work or input&lt;&#x2F;h4&gt;
&lt;p&gt;A few studies highlighted that multi-tasking is pretty bad for your brain, and for your mental health.
We also know that anyone will keep thinking about something if they do not consider that this thing is done and behind them.&lt;&#x2F;p&gt;
&lt;p&gt;So, what can we do about that, as a tech lead or similar role?&lt;&#x2F;p&gt;
&lt;p&gt;Well, we can task somebody to do something, and force them to rewrite everything after a few days, by sneaking up a pull request during the night that completely changes parts of the codebase, and we can even blame the delay on them. Bonus point if we slip a little &quot;We should use another library and drop the old one while doing this task&quot; once this task is nearly done.&lt;&#x2F;p&gt;
&lt;p&gt;We can also do pointless code reviews, ie. making people format their code manually, following arbitrary rules not enforced by the formatter. Even better if those code reviews are meetings.&lt;&#x2F;p&gt;
&lt;p&gt;We can give them never-ending tasks, transforming a simple MVP draft into a moving target that keeps changing and being more complex.&lt;&#x2F;p&gt;
&lt;p&gt;We can also put all of our ego into the codebase, arguing about the tiniest change, blocking a big merge for one thing that we don&#x27;t like, but that won&#x27;t affect production, forcing the person in charge to delay other tasks on the sprint&#x27;s last day, just because we can&#x27;t accept later improvements, even if they come as soon as the next sprint&#x27;s first day, and even if they&#x27;re the best option to pick.&lt;&#x2F;p&gt;
&lt;p&gt;We can of course, make somebody work on something, and having them re-do everything because we do not like the shape of it. Bonus point if we do an infinite number of reviews, and even better if a review voids the last review changes.&lt;&#x2F;p&gt;
&lt;p&gt;And of course, we can require code review on pull requests while our own schedule do not allow it, delaying them and making the performer go back to tasks he did three weeks ago. Bonus point if the changes are about changing &quot;lorem ipsum&quot; to &quot;ipsum lorem&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;The request &quot;Please make another ticket&quot; is not a mark of laziness. I mean, sometimes, it can be. But there are good reasons to shape something, to consider it &lt;em&gt;not perfect&lt;&#x2F;em&gt;, but &lt;em&gt;good enough&lt;&#x2F;em&gt;, and to improve it with iterations. Especially if a first version has been manually tested. You don&#x27;t want to risk regressions because new features popped in after QA.&lt;&#x2F;p&gt;
&lt;p&gt;Working in a company with uncertain funding or market fit is a lot about timing, tests, quick (and stable) prototypes that you improve or esentually replace, and listening to your team is also important.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;denying-reality&quot;&gt;Denying reality&lt;&#x2F;h4&gt;
&lt;p&gt;There&#x27;s nothing worse for a leader than denying reality about the market he&#x27;s trying to enter in, or about the financial status of his own company.&lt;&#x2F;p&gt;
&lt;p&gt;The leader is the ship&#x27;s captain. If your team feels numbers aren&#x27;t good, and your only response is to hide metrics on the next week slides, not discussing measures, or in general, not mentioning the elephant in the room, then your team anxiety level is going to increase, significantly.&lt;&#x2F;p&gt;
&lt;p&gt;Working in a startup is hard. From my humble experience, leading small teams is even harder.  But ignoring the hole in the ship&#x27;s hull is not going to help.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;bitching-about-others-and-denying-responsibility&quot;&gt;Bitching about others and denying responsibility&lt;&#x2F;h4&gt;
&lt;p&gt;It is certain that a shortage of funds and treasury can damage a company (or even a person) in many ways. And people can indeed demonstrate skill issues, or take actions that will have deep negative consequences.&lt;&#x2F;p&gt;
&lt;p&gt;But the worst thing somebody can do is bitching about others, whether they&#x27;re still in the company or have been fired, or &lt;em&gt;encouraged&lt;&#x2F;em&gt; to leave, or whether they can even hear you in the next room.&lt;&#x2F;p&gt;
&lt;p&gt;Everybody makes mistakes, except people doing nothing, and while there&#x27;s no point in blaming yurself forever for something you did, you should always acknowledge that you did that mistake. No need for humiliating speeches in front of 300 people, just a simple statement such as: &quot;Ok, I did this [because I thought this], it didn&#x27;t go well. Now, here&#x27;s how I plan to fix it.&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;Do not blame a junior account manager sending a few hundreds to the wrong bank account, insulting them in the next room, while you do not take responsibility for your own implementation that makes the company lose money by the thousands on a monthly basis.&lt;&#x2F;p&gt;
&lt;p&gt;Also, do not blame a performer for the time a feature took, if you were one of the bottlenecks behind it, whether by lack of time or planning.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;m in no way considering myself a good manager. I&#x27;m pretty sure I did a lot of mistakes when I had to manage a team myself, and I&#x27;m pretty sure the pressure is even worse when you build a company and put your time and energy behind it.&lt;&#x2F;p&gt;
&lt;p&gt;So, what makes a good manager or startup leader? I&#x27;m definitely not sure about that, but I do have a few ideas:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Be trustful.&lt;&#x2F;li&gt;
&lt;li&gt;Be respectful. Always. If you have complaints, go to the person and tell them about it, do not bitch over somebody else&#x27;s shoulder at hearing distance.&lt;&#x2F;li&gt;
&lt;li&gt;Listen to your team.&lt;&#x2F;li&gt;
&lt;li&gt;Take responsibility when necessary.&lt;&#x2F;li&gt;
&lt;li&gt;Allow others to fail and take accountability, don&#x27;t be the gatekeeper to everything.&lt;&#x2F;li&gt;
&lt;li&gt;Do not delay hard decisions.&lt;&#x2F;li&gt;
&lt;li&gt;Keep the long personal stories for the coffee breaks and afterworks.&lt;&#x2F;li&gt;
&lt;li&gt;Finally, feed your soldiers and eat last :)&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Of course, I do not pretend to be the guardian of truth, and I would be more than happy to get feedback, and to hear from you in the comments section, or on the various social medias I will link this article on.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: Having multiple Live Views on the same page</title>
          <pubDate>Fri, 25 Jul 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20250725-live-view-session/</link>
          <guid>https://mbuffa.github.io/articles/20250725-live-view-session/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20250725-live-view-session/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;In its early versions and up until v1.0, Phoenix LiveView has been designed to let you manage one LiveView at a time. But in a few cases, you&#x27;ll need to be able to manage multiple Live Views, for either a complex dashboard, or even a navigation menu living on the side.&lt;&#x2F;p&gt;
&lt;p&gt;In my case, I had to implement a navigation bar in one of my projects, with a different class for the active element. Using a Live Component was not possible, because those can&#x27;t be called from a regular (non-Live) template.&lt;&#x2F;p&gt;
&lt;p&gt;Although, since Live Views are GenServers, and therefore Processes, having one Process per user constantly running just for displaying a dynamic navigation bar isn&#x27;t great. It would be much better to save those few kilobytes of RAM, and do the work with pure CSS and JS hooks, therefore offloading the logic to the client. But let&#x27;s just consider we need two LiveViews sitting next to each other for our use case.&lt;&#x2F;p&gt;
&lt;p&gt;This is where &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;phoenix_live_view&#x2F;Phoenix.LiveView.Router.html#live_session&#x2F;3&quot;&gt;&lt;code&gt;live_session&#x2F;3&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; comes into play.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;usage&quot;&gt;Usage&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;live_session&#x2F;3&lt;&#x2F;code&gt; is a Router-specific &quot;word&quot; (in the Router DSL) that lets you define a handful of things:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A &lt;code&gt;name&lt;&#x2F;code&gt; to identify it&lt;&#x2F;li&gt;
&lt;li&gt;A &lt;code&gt;session&lt;&#x2F;code&gt; argument, in case you want to put a value in the connection (HTTP) Session&lt;&#x2F;li&gt;
&lt;li&gt;A &lt;code&gt;root_layout&lt;&#x2F;code&gt; argument, in case you want to override it (it may already be specified in your pipeline)&lt;&#x2F;li&gt;
&lt;li&gt;A &lt;code&gt;layout&lt;&#x2F;code&gt; argument, to specify a &quot;partial view&quot; that&#x27;ll be rendered inside your root layout&lt;&#x2F;li&gt;
&lt;li&gt;An &lt;code&gt;on_mount&lt;&#x2F;code&gt; callback to specify a list of functions to call in order to update the socket&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;example&quot;&gt;Example&lt;&#x2F;h2&gt;
&lt;p&gt;This is how my code looks like:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# router.ex
&lt;&#x2F;span&gt;&lt;span&gt;live_session &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:admin&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;on_mount: &lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;SutoWeb&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;InitAssigns&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:admin&lt;&#x2F;span&gt;&lt;span&gt;},
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;layout: &lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;SutoWeb&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Layouts&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:&amp;quot;live.admin&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;} &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  scope &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&#x2F;admin&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;SutoWeb&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Admin &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;    pipe_through &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:admin
&lt;&#x2F;span&gt;&lt;span&gt;    live &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;IndexLive
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# init_assigns.ex
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;defmodule &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;SutoWeb&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;InitAssigns &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Phoenix&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Component
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;on_mount&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:admin&lt;&#x2F;span&gt;&lt;span&gt;, _params, _session, socket) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;    current_page =
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;case &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Atom&lt;&#x2F;span&gt;&lt;span&gt;.to_string(socket.view) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;        &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Elixir.SutoWeb.Admin.AuthLive&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &amp;lt;&amp;gt; _rest -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:auth
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Elixir.SutoWeb.Admin.ChannelLive&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &amp;lt;&amp;gt; _rest -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:channels
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Elixir.SutoWeb.Admin.TimerLive&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &amp;lt;&amp;gt; _rest -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:timers
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        ...
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:cont&lt;&#x2F;span&gt;&lt;span&gt;, assign(socket, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:current_page&lt;&#x2F;span&gt;&lt;span&gt;, current_page)}
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# Partial layout
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;div class=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;min-h-screen h-full flex flex-row bg-gray-300&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;  &amp;lt;.live_component
&lt;&#x2F;span&gt;&lt;span&gt;    module={&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;SutoWeb&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Admin&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;NavLive&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;    id=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;nav&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    class=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;p-5&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    current_page={assigns.current_page}
&lt;&#x2F;span&gt;&lt;span&gt;  &#x2F;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;  &amp;lt;main class=&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;p-5 w-full h-screen overflow-auto&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;.flash_group flash={@&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;flash&lt;&#x2F;span&gt;&lt;span&gt;} &#x2F;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {@&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;inner_content&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;  &amp;lt;&#x2F;main&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&#x2F;div&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And the &lt;code&gt;NavLive&lt;&#x2F;code&gt; module here is just a navigation bar built with &lt;a href=&quot;https:&#x2F;&#x2F;petal.build&#x2F;&quot;&gt;Petal Framework&lt;&#x2F;a&gt;, defining list items and picking the right Tailwind class for the active item.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s it :) Please keep in mind that using a Live Session for something that could be offloaded to the client (with JavaScript and hooks) isn&#x27;t great, but this gives you an idea on what structure to use, in case you&#x27;re building a complex trading dashboard, and you absolutely need to have separate LiveViews on the same page, for concurrency reasons or resilience.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Unix: Loading env variables, without messing up your environment</title>
          <pubDate>Thu, 27 Feb 2025 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20250227-loading-env-without-leaks/</link>
          <guid>https://mbuffa.github.io/articles/20250227-loading-env-without-leaks/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20250227-loading-env-without-leaks/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;If you&#x27;re developing a server or a web app, and this server needs to interact with third-party services, you&#x27;re probably going to use a &lt;code&gt;.env&lt;&#x2F;code&gt; (dotenv) file to define those variables. At least, when running your project locally.&lt;&#x2F;p&gt;
&lt;p&gt;So, you would probably end up doing something like &lt;code&gt;export $(cat .env | xargs)&lt;&#x2F;code&gt;, and then running your process.&lt;&#x2F;p&gt;
&lt;p&gt;This approach has one major drawback: it updates the environment of your current shell, and it has a few implications:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;If you&#x27;re working with several services, with various &lt;code&gt;dotenv&lt;&#x2F;code&gt; files, you may end up overwriting variables, or relying on variables defined by other services...&lt;&#x2F;li&gt;
&lt;li&gt;...worst-case scenario, you end up connecting to a production database when running a task that was supposed to run against a test database, and things go wild.&lt;&#x2F;li&gt;
&lt;li&gt;You may leak tokens every time you call &lt;code&gt;env&lt;&#x2F;code&gt; in your terminal. Not ideal if you&#x27;re streaming your content.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;You can actually make sure your application loads its necessary environment variables without those inconveniences, either by using a Shell script, or a Makefile. Two very simple solutions compared to, say, setting up and maintaining SOPS&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;getsops&#x2F;sops&quot;&gt;1&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;So, basically by adding something like &lt;code&gt;server.sh&lt;&#x2F;code&gt; with the following:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;#!&#x2F;bin&#x2F;sh
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt;(cat .env | xargs)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# Running your server
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Your env will be loaded inside the context of a new TTY (if I remember my UNIX lessons correctly).&lt;&#x2F;p&gt;
&lt;p&gt;It also works with Makefiles (and yeah, I hate the syntax, it&#x27;s annoying and weird, but I always end up writing Makefiles):&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;Makefile&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-Makefile &quot;&gt;&lt;code class=&quot;language-Makefile&quot; data-lang=&quot;Makefile&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;include &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;.env
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;export
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;server&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# Running your server
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And that&#x27;s it. Also, make sure your variables are properly defined (such as &lt;code&gt;FOO=bar&lt;&#x2F;code&gt;, without quotes) because having additional quotes may cause issues (some loaders would escape quotes).&lt;&#x2F;p&gt;
&lt;p&gt;Not a revolutionary take, but better be safe (and clean) than sorry!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Postgres: Using SQL generated columns</title>
          <pubDate>Tue, 30 Jan 2024 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/</link>
          <guid>https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20231212-postgres-autogenerated-fields/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;strong&gt;Attention: This feature isn&#x27;t specific to PG, but that&#x27;s the only RDBMS I use on a regular basis, so variations may apply.&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;TL;DR: You can define a field generated at row insertion, instead of inferring a dynamic value.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;When designing your data model using a relational database, you might encounter a case where you&#x27;d need to link a table to numerous other tables.&lt;&#x2F;p&gt;
&lt;p&gt;In that case, you might be tempted to use a polymorphic association, but this comes at the cost of sacrificing data integrity with the loss of foreign keys.&lt;&#x2F;p&gt;
&lt;p&gt;One simple alternative consists of having one foreign key per relation. It is simple and reliable, at least until you reach a large number of foreign keys.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s say we have the following schema:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;items
&lt;&#x2F;span&gt;&lt;span&gt;----        todos
&lt;&#x2F;span&gt;&lt;span&gt;id          -----
&lt;&#x2F;span&gt;&lt;span&gt;todo_id --&amp;gt; id      posts
&lt;&#x2F;span&gt;&lt;span&gt;...         title   -----
&lt;&#x2F;span&gt;&lt;span&gt;post_id ----------&amp;gt; id
&lt;&#x2F;span&gt;&lt;span&gt;                    title
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We might want to know the &quot;type&quot; of relation our row is linked to, without having to use a case-when statement on each SQl query, which would be costly - and&#x2F;or at least inefficient.&lt;&#x2F;p&gt;
&lt;p&gt;How about adding a string field representing the relation type? It&#x27;s fine. But our model may change, and we might have to declare a new type, and yet forget to add the new possible value.&lt;&#x2F;p&gt;
&lt;p&gt;This is a situation where SQL generated columns can be handy.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;usage&quot;&gt;Usage&lt;&#x2F;h2&gt;
&lt;p&gt;A generated column is typically created like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sql&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sql &quot;&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;ALTER TABLE &lt;&#x2F;span&gt;&lt;span&gt;$TABLE_NAME ADD COLUMN $FIELD_NAME $FIELD_TYPE GENERATED AS (
&lt;&#x2F;span&gt;&lt;span&gt;  $GENERATION_EXPRESSION
&lt;&#x2F;span&gt;&lt;span&gt;) STORED;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A few key points here:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;$GENERATION_EXPRESSION&lt;&#x2F;code&gt; can be any statement returning a value,&lt;&#x2F;li&gt;
&lt;li&gt;Postgres only supports stored values.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;So, in our case, the field definition would look like this:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;ALTER TABLE items ADD COLUMN relation_type string GENERATED AS (
&lt;&#x2F;span&gt;&lt;span&gt;  CASE
&lt;&#x2F;span&gt;&lt;span&gt;    WHEN &amp;#39;post_id&amp;#39; IS NOT NULL THEN &amp;#39;post&amp;#39;
&lt;&#x2F;span&gt;&lt;span&gt;    WHEN &amp;#39;todo_id&amp;#39; IS NOT NULL THEN &amp;#39;todo&amp;#39;
&lt;&#x2F;span&gt;&lt;span&gt;  END
&lt;&#x2F;span&gt;&lt;span&gt;) STORED;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;implications&quot;&gt;Implications&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;introducing-new-foreign-keys&quot;&gt;Introducing new foreign keys&lt;&#x2F;h3&gt;
&lt;p&gt;You may need to introduce new foreign keys. In that case, you&#x27;ll need to alter the table again and add a new condition to your generator expression.&lt;&#x2F;p&gt;
&lt;p&gt;You might be tempted to add a default &quot;unknown&quot; value, but I think explicit failure should be prefered in that case.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;testing&quot;&gt;Testing&lt;&#x2F;h3&gt;
&lt;p&gt;Since we basically have an enumeration, we might want to iterate over this enumeration in our tests, so that we can check that our codebase actually handles all the possible values it can take (eg. for exposing values on a GraphQL API).&lt;&#x2F;p&gt;
&lt;p&gt;And it turns out we can retrieve that information from Postgres!&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;SELECT generation_expression
&lt;&#x2F;span&gt;&lt;span&gt;        FROM information_schema.columns
&lt;&#x2F;span&gt;&lt;span&gt;        WHERE table_schema = &amp;#39;public&amp;#39;
&lt;&#x2F;span&gt;&lt;span&gt;        AND table_name   = &amp;#39;items&amp;#39;
&lt;&#x2F;span&gt;&lt;span&gt;        AND column_name = &amp;#39;relation_type&amp;#39;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will return the raw SQL statement used to generate new values. It&#x27;s a bit sketchy, but you can parse this expression with simple regexps and extract what you need.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;Generated fields are a simple but powerful tool, and you can use it in a lot of scenarios I didn&#x27;t mention, such as generating a tsvector for full text search, or simplifying basic yet cumbersome checks.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>A* (A Star) Live Demo</title>
          <pubDate>Sun, 20 Nov 2022 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/demos/20221120-astar-live-demo/</link>
          <guid>https://mbuffa.github.io/demos/20221120-astar-live-demo/</guid>
          <description xml:base="https://mbuffa.github.io/demos/20221120-astar-live-demo/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;This is a live demonstration of the A* pathfinding algorithm implemented in Elixir using LiveView. The implementation itself is a functional step-by-step version of the famous A* algorithm, which is most commonly used in video games.&lt;&#x2F;p&gt;
&lt;p&gt;I hacked the original version of this demo over a weekend in Feb 2021, ingesting a lot of content about pathing, and a bit about LiveView, in order to showcase it during an internal talk at Pandascore. I got back to it and refactored the whole thing later to clean it up.&lt;&#x2F;p&gt;
&lt;p&gt;Please keep in mind that this is, however, not a perfect example of algorithmic efficiency (there&#x27;s a lot of linear search through lists and it could probably be better), and that there might be mistakes or imprecisions about my implementation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-a&quot;&gt;What is A*?&lt;&#x2F;h2&gt;
&lt;div class=&quot;video-embed&quot; &gt;
  &lt;iframe
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;-L-WgKMFuhE&quot;
    webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;&lt;h2 id=&quot;demo&quot;&gt;Demo&lt;&#x2F;h2&gt;
&lt;p&gt;Head over to &lt;a href=&quot;https:&#x2F;&#x2F;path-demo.fly.dev&quot;&gt;Fly.io&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;You control the robot. Pick a target, find the path, and walk the path.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;repo&quot;&gt;Repo&lt;&#x2F;h2&gt;
&lt;p&gt;Source code is available on &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mbuffa&#x2F;elixir-pathfinding-demo&quot;&gt;Github&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Kubernetes: Creating and using Operators</title>
          <pubDate>Sat, 22 Jan 2022 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20220122-kubernetes-operators/</link>
          <guid>https://mbuffa.github.io/articles/20220122-kubernetes-operators/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20220122-kubernetes-operators/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;I recently had to deploy a variant of an existing application, with a small set of common REST APIs with additional endpoints, and a few specific applications to fit the business needs of that product. I encountered an issue though: my ingress configuration (using Traefik) needed to have access to my certificate in that same namespace. I&#x27;m pretty sure Kubernetes namespaces are completely isolated compartments, but I tried to access that secret in my default namespace nonetheless, without success.&lt;&#x2F;p&gt;
&lt;p&gt;Also, that certificate would be renewed every once in a while.&lt;&#x2F;p&gt;
&lt;p&gt;So I basically had three solutions:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Copy the secret manually, initially and then after each certificate update&lt;&#x2F;li&gt;
&lt;li&gt;Update the certificate update procedure, so that the person updating it would also update the one in my namespace&lt;&#x2F;li&gt;
&lt;li&gt;Copy the secret on a regular basis, either with a Kubernetes CronJob or a deployed app&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The first solution was too error-prone. I&#x27;d rather write and validate a script once and schedule it, rather than trusting my self in six months, with clouded memory and human nature.&lt;&#x2F;p&gt;
&lt;p&gt;The second solution would have required me to have access to that update procedure, and having anyone deploying in a new namespace the obligation to update that procedure (or warn about it) for each new namespace. Not really resilient to human errors and not scalable by definition.&lt;&#x2F;p&gt;
&lt;p&gt;The third solution was the most tempting, but I found a more elegant and equally reliable way to do this.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;solving-this-with-an-operator&quot;&gt;Solving this with an Operator&lt;&#x2F;h2&gt;
&lt;p&gt;A &lt;a href=&quot;https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;concepts&#x2F;extend-kubernetes&#x2F;operator&#x2F;&quot;&gt;Kubernetes Operator&lt;&#x2F;a&gt; is a fancy word for applications subscribing to the Kubernetes event loop and executing some code in return. Classic PubSub.&lt;&#x2F;p&gt;
&lt;p&gt;Operators aren&#x27;t a ressource as can be Pods, Deployments or ConfigMaps. They&#x27;re just deployed apps with a certain design, and there are several ways to create one.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-don-t-reinvent-the-wheel-way&quot;&gt;The Don&#x27;t-Reinvent-The-Wheel way&lt;&#x2F;h2&gt;
&lt;p&gt;In my case, I wanted to have something running in a reanosably short timespan. There are ways to build your own operator &quot;from scratch&quot; (at least, without &lt;a href=&quot;https:&#x2F;&#x2F;youtu.be&#x2F;zSgiXGELjbc&quot;&gt;having to invent the universe&lt;&#x2F;a&gt;), but I went for an &quot;out-of-the-box&quot; solution called &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;flant&#x2F;shell-operator&quot;&gt;shell-operator&lt;&#x2F;a&gt;, allowing you to write a simple YAML manifest for the subscription, and some UNIX shell scripting for the code execution.&lt;&#x2F;p&gt;
&lt;p&gt;The README is pretty straightforward and does a very good job, so I won&#x27;t elaborate step-by-step on this. There are even examples, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;flant&#x2F;shell-operator&#x2F;tree&#x2F;main&#x2F;examples&#x2F;101-monitor-pods&quot;&gt;such as this one&lt;&#x2F;a&gt;. I wouldn&#x27;t do a better job than the author himself. Advertising the use of Operators is the best I can do here :-)&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, you basically end up with a Dockerfile, a shell script both used to create the subscription hook and the code execution (in which you can of course run &lt;code&gt;kubectl apply -f&lt;&#x2F;code&gt; if it has the required permissions), and you only have to build your new container and deploy it.&lt;&#x2F;p&gt;
&lt;p&gt;In my case, I ended up having a specific deployment for every namespace I deployed (and that is intended to not be a temporary namespace, and have a lifetime superior to the renewal period). I could have deployed only one operator and have it update the secret in all namespaces at once, but that basically killed the principle of compartmented and independant namespaces.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-do-it-yourself-way&quot;&gt;The Do-It-Yourself way&lt;&#x2F;h2&gt;
&lt;p&gt;I also like to master what&#x27;s happening and have a low-level understanding of things, so I&#x27;ll try to update this article (or create a new one) about creating your own operator soon. Yeah, sorry, that section is currently a scam.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Kubernetes: Kubectl Useful shortcuts</title>
          <pubDate>Mon, 20 Dec 2021 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20211220-kubectl-shortcuts/</link>
          <guid>https://mbuffa.github.io/articles/20211220-kubectl-shortcuts/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20211220-kubectl-shortcuts/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;kubectl&lt;&#x2F;code&gt; is the command line tool for accessing and interacting with your Kubernetes cluster. It&#x27;s quite intuitive and easy-to-use, but here is a small summary of some very useful commands to get you started if you&#x27;re new to Kube.&lt;&#x2F;p&gt;
&lt;p&gt;You should already know a few basics about building a Docker container and firing a simple deployment on Kubernetes though. This won&#x27;t help you much if you don&#x27;t know Kubernetes at all :-)&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, here&#x27;s a quick catch-up:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;To deploy a basic app on Kube, you would typically write a &lt;em&gt;Deployment&lt;&#x2F;em&gt;, featuring a template with a list of &lt;em&gt;Container&lt;&#x2F;em&gt;s.&lt;&#x2F;li&gt;
&lt;li&gt;Once applied, this &lt;em&gt;Deployment&lt;&#x2F;em&gt; will have an associated &lt;em&gt;ReplicaSet&lt;&#x2F;em&gt; linked to the template you specified, and managed by Kube.&lt;&#x2F;li&gt;
&lt;li&gt;Each &lt;em&gt;ReplicaSet&lt;&#x2F;em&gt; will then create &lt;em&gt;Pod&lt;&#x2F;em&gt;s accordingly (depending on the amount of replicas you set).&lt;&#x2F;li&gt;
&lt;li&gt;And finally, each &lt;em&gt;Pod&lt;&#x2F;em&gt; will wrap the &lt;em&gt;Container&lt;&#x2F;em&gt;s you specified in the aforementioned template.&lt;&#x2F;li&gt;
&lt;li&gt;Additionally, &lt;em&gt;Service&lt;&#x2F;em&gt;s will provide a single &lt;strong&gt;Endpoint&lt;&#x2F;strong&gt; to your app &lt;strong&gt;inside&lt;&#x2F;strong&gt; your cluster, while &lt;em&gt;Ingress&lt;&#x2F;em&gt;es will provide access from &lt;strong&gt;outside&lt;&#x2F;strong&gt; your cluster, redirecting traffic to the &lt;strong&gt;Service&lt;&#x2F;strong&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I&#x27;ll try to update this article if I discover or remember some good shortcuts. It would be pretty long and tedious if it was a full tutorial, so I&#x27;ll keep this light.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-good-entrypoint&quot;&gt;A good entrypoint&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;kubectl explain&lt;&#x2F;code&gt; is here to help you. You can use it on any kind of ressources inside Kubernetes:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kubectl&lt;&#x2F;span&gt;&lt;span&gt; explain deployments
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is really useful, especially when combined with some IDE plugins. VSCode has some that add snippets, and even a cluster visualizer that lets you browse all your ressources from inside your editor! You can easily learn something about a new type of ressource you didn&#x27;t know about.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-simple-way-to-open-a-tty-to-your-pod&quot;&gt;A simple way to open a TTY to your pod&lt;&#x2F;h2&gt;
&lt;p&gt;You may already know that you can open a terminal over SSH by simply running:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kubectl&lt;&#x2F;span&gt;&lt;span&gt; exec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -it&lt;&#x2F;span&gt;&lt;span&gt; my-app-1234-5678 -- &#x2F;bin&#x2F;sh
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you&#x27;re deploying quite often, the replicaset attached to your deployment will change, and pods will be recreated. Therefore, opening a new TTY can be tedious.&lt;&#x2F;p&gt;
&lt;p&gt;But fortunately, you can use the service as a shortcut:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kubectl&lt;&#x2F;span&gt;&lt;span&gt; exec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -it&lt;&#x2F;span&gt;&lt;span&gt; service&#x2F;my-app -- &#x2F;bin&#x2F;sh
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;accessing-multiple-apps-logs&quot;&gt;Accessing multiple apps logs&lt;&#x2F;h2&gt;
&lt;p&gt;You may know that you can access a container logs, either statically or continuously, by running this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kubectl&lt;&#x2F;span&gt;&lt;span&gt; logs &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;-f&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;]&lt;&#x2F;span&gt;&lt;span&gt; my-app-1234-5678 container_name
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;But yet again, the pod may be replaced, and you may be interested to fetch logs from multiple pods of the same app, or even logs coming from various apps, but serving a common purpose.&lt;&#x2F;p&gt;
&lt;p&gt;You can do just that by adding &lt;strong&gt;&lt;a href=&quot;https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;concepts&#x2F;overview&#x2F;working-with-objects&#x2F;labels&#x2F;&quot;&gt;Labels&lt;&#x2F;a&gt;&lt;&#x2F;strong&gt; to your ressources (especially deployments), and running the same command, but with &lt;em&gt;Label Selector&lt;&#x2F;em&gt;s instead:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kubectl&lt;&#x2F;span&gt;&lt;span&gt; logs &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;-f&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -l&lt;&#x2F;span&gt;&lt;span&gt; app=my-app&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -c&lt;&#x2F;span&gt;&lt;span&gt; container_name
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In fact, selectors can be used with many commands, including all &lt;code&gt;get&lt;&#x2F;code&gt; calls, to fetch ressources of different nature grouped by-whatever-your-semantic-grouping-is. No more &lt;code&gt;grep&lt;&#x2F;code&gt; :-)&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Unix: Saving and restoring your Homebrew packages</title>
          <pubDate>Fri, 29 Oct 2021 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20211029-homebrew-bundles/</link>
          <guid>https://mbuffa.github.io/articles/20211029-homebrew-bundles/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20211029-homebrew-bundles/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;If you&#x27;re using the Homebrew package manager on your Mac, there&#x27;s a small chance you may want to backup your list of packages and to be able to restore them in one command, especially if you got a computer for personal use and another one for professional use, or in case you have to restore your setup for whatever reason.&lt;&#x2F;p&gt;
&lt;p&gt;Homebrew provides bundles that does just that. To create one, just open your terminal and type:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;brew&lt;&#x2F;span&gt;&lt;span&gt; bundle dump
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will create a Brewfile containing all custom repositories and the list of all the packages you installed.&lt;&#x2F;p&gt;
&lt;p&gt;To restore it, simply run &lt;code&gt;brew bundle&lt;&#x2F;code&gt; and Homebrew will make sure you have all those packages installed.&lt;&#x2F;p&gt;
&lt;p&gt;This isn&#x27;t something huge, but I thought this deserved a bit of coverage from yet another Github Page :-)&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: Using Environment Variables</title>
          <pubDate>Thu, 16 Sep 2021 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20210916-elixir-environment-variables/</link>
          <guid>https://mbuffa.github.io/articles/20210916-elixir-environment-variables/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20210916-elixir-environment-variables/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;An environment variable is a widespread programming concept that refers to a value coming from the system, being read by an application at runtime. Elixir can be a bit surprising on that aspect for beginners.&lt;&#x2F;p&gt;
&lt;p&gt;This is one way of accessing an environment variable:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; HELLO=world iex
&lt;&#x2F;span&gt;&lt;span&gt;iex(1)&amp;gt; System.get_env(&amp;quot;HELLO&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;world&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And the same call would work in your application source code.&lt;&#x2F;p&gt;
&lt;p&gt;However, you may want to avoid scattering those calls in every corner, and use a config file instead to centralize your settings and your default values.&lt;&#x2F;p&gt;
&lt;p&gt;Mix doesn&#x27;t generate config files by default, so you&#x27;d have to create one of those, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;mix&lt;&#x2F;span&gt;&lt;span&gt; new foo
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span&gt; foo
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;mkdir&lt;&#x2F;span&gt;&lt;span&gt; config
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;touch&lt;&#x2F;span&gt;&lt;span&gt; config&#x2F;config.exs
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And edit your &lt;code&gt;config&#x2F;config.exs&lt;&#x2F;code&gt; file, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Config
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;config &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:foo&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;hello: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;System&lt;&#x2F;span&gt;&lt;span&gt;.get_env(&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;HELLO&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And lastly, modify &lt;code&gt;lib&#x2F;foo.ex&lt;&#x2F;code&gt; like this, to actually use the key-value pair we defined:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span&gt;module &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Foo &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;  # ...
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;hello &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Application&lt;&#x2F;span&gt;&lt;span&gt;.get_env(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:foo&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:hello&lt;&#x2F;span&gt;&lt;span&gt;, &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;default&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, we want to produce a build, but let&#x27;s define our environment variable just before we do that:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;HELLO&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;foo
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;MIX_ENV&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;prod &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;mix&lt;&#x2F;span&gt;&lt;span&gt; release
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now let&#x27;s run an interactive terminal to our build, and let&#x27;s override that env variable along the way:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;HELLO&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;bar &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;.&#x2F;_build&#x2F;prod&#x2F;rel&#x2F;foo&#x2F;bin&#x2F;foo&lt;&#x2F;span&gt;&lt;span&gt; start_iex
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There, calling &lt;code&gt;Foo.hello&lt;&#x2F;code&gt; would return &quot;foo&quot;, not &quot;bar&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;You can easily get surprises when releasing your first Elixir app, because this is not something you can reliably reproduce with &lt;code&gt;iex -S mix&lt;&#x2F;code&gt; locally.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-happened&quot;&gt;What happened&lt;&#x2F;h2&gt;
&lt;p&gt;Well basically, &lt;code&gt;exs&lt;&#x2F;code&gt; files are script files: they&#x27;re used at build or test times, and aren&#x27;t present in your final build. When building your release, Mix interpreted &lt;code&gt;System.get_env&lt;&#x2F;code&gt; directly and hardcoded the value.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;solutions&quot;&gt;Solutions&lt;&#x2F;h2&gt;
&lt;p&gt;One exception to that is the Elixir 1.11 addition &lt;code&gt;config&#x2F;runtime.exs&lt;&#x2F;code&gt; file, meant to be &quot;compiled&quot; at runtime.&lt;&#x2F;p&gt;
&lt;p&gt;Of course, you could argue that using &lt;code&gt;System.get_env&lt;&#x2F;code&gt; directly in your source code would work, but I would say this wouldn&#x27;t be a great idea ;-)&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s an alternative to &lt;code&gt;config&#x2F;runtime.exs&lt;&#x2F;code&gt; though, &lt;a href=&quot;https:&#x2F;&#x2F;hex.pm&#x2F;packages&#x2F;env&quot;&gt;which is the &lt;code&gt;env&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt;. It lets you define tuples in your config files, and a getter similar to &lt;code&gt;Application.get_env&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# In your config files:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Config
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;config &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:test&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;hello: &lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:system&lt;&#x2F;span&gt;&lt;span&gt;, &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;HELLO&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;, &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;world&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# In your codebase:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Env&lt;&#x2F;span&gt;&lt;span&gt;.fetch(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:test&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:hello&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;em&gt;Et voil !&lt;&#x2F;em&gt; Hope this helps.&lt;&#x2F;p&gt;
&lt;p&gt;If you want to know more about Elixir builds and releases, as always, &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;mix&#x2F;1.12&#x2F;Mix.Tasks.Release.html&quot;&gt;the official documentation is a great place to start&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;2025-update&quot;&gt;2025 Update&lt;&#x2F;h2&gt;
&lt;p&gt;I wanted to make an update a while ago to state one thing: you probably don&#x27;t need a library such as &lt;code&gt;env&lt;&#x2F;code&gt; in your application. You just have to remember the following statements:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Your configuration is split between environments (&lt;code&gt;config&#x2F;{dev,test,prod}.exs&lt;&#x2F;code&gt;) which is built at compilation time&lt;&#x2F;li&gt;
&lt;li&gt;You have to make sure your environment variables are defined at compilation time if you make calls to &lt;code&gt;System.get_env&lt;&#x2F;code&gt;, otherwise, your config would contain empty settings. You can check &lt;a href=&quot;&#x2F;articles&#x2F;20250227-loading-env-without-leaks&quot;&gt;this article&lt;&#x2F;a&gt; for the most optimal way to do that locally.&lt;&#x2F;li&gt;
&lt;li&gt;There&#x27;s one exception to that: &lt;code&gt;config&#x2F;runtime.exs&lt;&#x2F;code&gt; is &lt;em&gt;always&lt;&#x2F;em&gt; evaluated at runtime, and not only in production. This is where you can reliably call &lt;code&gt;System.get_env&lt;&#x2F;code&gt;. Just be cautious and insert production configuration inside the right &quot;block&quot; in there, because it&#x27;s also used for dev and test.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;There&#x27;s actually another exception you may come across in older Elixir projects, which is &lt;code&gt;config&#x2F;releases.exs&lt;&#x2F;code&gt;, used until Elixir v1.11.0.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, checking both &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;elixir&#x2F;config-and-releases.html&quot;&gt;Elixir&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;mix&#x2F;1.18.4&#x2F;Mix.Tasks.Release.html&quot;&gt;Mix&lt;&#x2F;a&gt; documentations for your versions is always a good idea.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Kubernetes: Using Environment Variables with Kustomize</title>
          <pubDate>Tue, 20 Jul 2021 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20210720-kustomize-environment-variables/</link>
          <guid>https://mbuffa.github.io/articles/20210720-kustomize-environment-variables/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20210720-kustomize-environment-variables/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;Using environment variables in your Kubernetes manifests built with Kustomize may be a bit tedious, but I recently found how you can actually use some.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;&#x2F;h2&gt;
&lt;p&gt;I won&#x27;t go into too much details about Kubernetes manifests, or deploying on Kubernetes in general. I learned as I went, mostly by looking at examples and documentation. If you&#x27;re looking for tutorials or courses, there are pretty good resources available for free. &lt;a href=&quot;https:&#x2F;&#x2F;prefetch.net&#x2F;blog&#x2F;2019&#x2F;10&#x2F;16&#x2F;the-beginners-guide-to-creating-kubernetes-manifests&#x2F;&quot;&gt;This great article&lt;&#x2F;a&gt; gives some very useful tips to learn by doing, and there&#x27;s even &lt;a href=&quot;https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;tutorials&#x2F;kubernetes-basics&#x2F;deploy-app&#x2F;deploy-interactive&#x2F;&quot;&gt;an official interactive tutorial&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;And, of course, you also need to know Docker :-)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;let-s-get-started&quot;&gt;Let&#x27;s get started&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s take this stripped down deployment example, named &lt;code&gt;deployment.yaml&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;apiVersion&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;apps&#x2F;v1
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Deployment
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;namespace&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;default
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;selector&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;matchLabels&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;replicas&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;template&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;containers&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;image&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP:latest
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;resources&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;requests&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cpu&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;100m
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;100Mi
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;limits&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cpu&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;100m
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;100Mi
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;env&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;DB_HOST
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;valueFrom&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;configMapKeyRef&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span&gt;                  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;DB_HOST
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;ports&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;containerPort&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;80
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;restartPolicy&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Always
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You would typically associate this with a &lt;code&gt;Kustomization.yaml&lt;&#x2F;code&gt; file:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;resources&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;deployment.yaml
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This file allows you to define values shared across multiple resources (like services, jobs, ingresses...), either by editing it directly, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;resources&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;deployment.yaml
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;namespace&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;web
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;...or programmatically, for example, in your CI:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; kustomize edit set namespace web
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Running &lt;code&gt;kustomize build .&lt;&#x2F;code&gt; in the directory containing your kustomization and deployment would result in an output that you could apply directly with &lt;code&gt;kubectl apply&lt;&#x2F;code&gt;. Just run &lt;code&gt;kustomize build . | kubectl apply -f -&lt;&#x2F;code&gt; and you&#x27;re good to go.&lt;&#x2F;p&gt;
&lt;p&gt;Now let&#x27;s say we want to add an annotation at build time in our CI with an environment variable, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;apiVersion&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;apps&#x2F;v1
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Deployment
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;MYAPP
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;template&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;annotations&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;example.com&#x2F;git-commit&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;$(CI_COMMIT_SHORT_SHA)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This can be pretty useful if, for example, you want to do a new deployment even if the docker image specified in that deployment hasn&#x27;t changed.&lt;&#x2F;p&gt;
&lt;p&gt;Running &lt;code&gt;kustomize build .&lt;&#x2F;code&gt; now would keep that line as-is.&lt;&#x2F;p&gt;
&lt;p&gt;In that case, you &lt;em&gt;could&lt;&#x2F;em&gt; add an annotation programmatically, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kustomize&lt;&#x2F;span&gt;&lt;span&gt; edit add annotation example.com&#x2F;git_commit:$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;CI_COMMIT_SHORT_SHA
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;But then all your resources would be affected, mearning that your service and ingress would also be redeployed in that example. In some cases, you really want to scope your changes.&lt;&#x2F;p&gt;
&lt;p&gt;To use environment variables, you need to specify them in your &lt;code&gt;Kustomization&lt;&#x2F;code&gt;, in a &lt;code&gt;vars:&lt;&#x2F;code&gt; section:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;resources&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;deployment.yaml
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;vars&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;CI_COMMIT_SHORT_SHA
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;objref&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;ConfigMap
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;environment-variables
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;apiVersion&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;v1
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fieldref&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fieldpath&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;data.CI_COMMIT_SHORT_SHA
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Each variable defined here must have a name and references to let Kustomize know where it&#x27;s supposed to get that value. In that example, I&#x27;m using a &lt;code&gt;configMap&lt;&#x2F;code&gt;, which is often the best option to store configuration.&lt;&#x2F;p&gt;
&lt;p&gt;While we could definitely define a &lt;code&gt;ConfigMap&lt;&#x2F;code&gt; ourselves as part of our &lt;code&gt;Resources&lt;&#x2F;code&gt;, we would lose the ability to define that variable at build time.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s why we want to build a &lt;code&gt;ConfigMap&lt;&#x2F;code&gt; programmatically, by sourcing a file we&#x27;ll create in our CI:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;resources&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;deployment.yaml
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;configMapGenerator&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;environment-variables
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;envs&lt;&#x2F;span&gt;&lt;span&gt;: [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;environment-properties.env&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;behavior&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;create
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;vars&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There&#x27;s one more thing we need to do though. For the sake of testing your code locally, just create a file named &lt;code&gt;environment-properties.env&lt;&#x2F;code&gt; containing the following content:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;CI_COMMIT_SHORT_SHA=unknown
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;(You should keep that file tracked in your CI, it would make debugging locally easier.)&lt;&#x2F;p&gt;
&lt;p&gt;Running &lt;code&gt;kustomize build .&lt;&#x2F;code&gt; at this point would, still, keep that variable as-is. That&#x27;s because we try to substitute a value in a field that Kustomize doesn&#x27;t look in by default, probably for performance or security concerns.&lt;&#x2F;p&gt;
&lt;p&gt;To fix this, we need to add a custom transformer. Put that in your Kustomization:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;configurations&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;env-var-transformer.yaml
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And then create &lt;code&gt;env-var-transformer.yaml&lt;&#x2F;code&gt; with that content:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;varReference&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Deployment
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;path&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;spec&#x2F;template&#x2F;metadata&#x2F;annotations
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, running &lt;code&gt;kustomize build .&lt;&#x2F;code&gt; locally should give you the expected result.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, in our CI job, we can build that file:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span&gt; CI_COMMIT_SHORT_SHA=$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;CI_COMMIT_SHORT_SHA &lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; environment-properties.env
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# And then, you just have to apply your changes:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kustomize&lt;&#x2F;span&gt;&lt;span&gt; build . |&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kubectl&lt;&#x2F;span&gt;&lt;span&gt; apply&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -f&lt;&#x2F;span&gt;&lt;span&gt; -
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now running &lt;code&gt;kustomize build .&lt;&#x2F;code&gt; would result in this :-)&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;apiVersion&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;v1
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;data&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;CI_COMMIT_SHORT_SHA&lt;&#x2F;span&gt;&lt;span&gt;: &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;123456&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;ConfigMap
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;environment-variables-2t266m664k
&lt;&#x2F;span&gt;&lt;span&gt;---
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;apiVersion&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;apps&#x2F;v1
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Deployment
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;template&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;annotations&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;example.com&#x2F;git-commit&lt;&#x2F;span&gt;&lt;span&gt;: &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;123456&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Tada!&lt;&#x2F;p&gt;
&lt;p&gt;Kustomize has a predefined list of fields it&#x27;ll actually replace corresponding patterns with environment variables. You can check this list &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;kustomize&#x2F;blob&#x2F;a280cdf5eeb748f5a72c8d94164ffdd68d03c5ce&#x2F;api&#x2F;konfig&#x2F;builtinpluginconsts&#x2F;varreference.go&quot;&gt;directly in the repository&lt;&#x2F;a&gt;. If you want to do variable substitution in a field that is not in that list, you can follow the section &lt;code&gt;I want to put $VAR in some (currently disallowed) field&lt;&#x2F;code&gt; &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;kustomize&#x2F;issues&#x2F;2052&quot;&gt;on this Github issue&lt;&#x2F;a&gt;, which points to the aforementioned source file.&lt;&#x2F;p&gt;
&lt;p&gt;Hope this will help some people stumbling around here.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Postgres: Filtering with COUNT()</title>
          <pubDate>Tue, 06 Jul 2021 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20210706-postgres-filtering-with-count/</link>
          <guid>https://mbuffa.github.io/articles/20210706-postgres-filtering-with-count/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20210706-postgres-filtering-with-count/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;Doing a COUNT() in SQL is pretty simple, but sometimes you want to return several counts at once with different filters. To achieve this, you would typically do multiple queries, &lt;a href=&quot;https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;9.1&#x2F;queries-with.html&quot;&gt;optionally with a &lt;code&gt;WITH&lt;&#x2F;code&gt; query&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Thankfully, there&#x27;s a way simpler way to do this in PostgreSQL, with &lt;code&gt;FILTER&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s consider we have a simple table (&lt;code&gt;racoons&lt;&#x2F;code&gt;) with a few fields, and we want to return a &lt;code&gt;caretaker_id&lt;&#x2F;code&gt;, the total number of racoons taken care by this person, and the number of racoons that have been released to the wilds.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s as simple as this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sql&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sql &quot;&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;SELECT   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;r&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;caretaker_id&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;         &lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;COUNT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;) as total,
&lt;&#x2F;span&gt;&lt;span&gt;         &lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;COUNT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;) FILTER (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;WHERE&lt;&#x2F;span&gt;&lt;span&gt; released = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;true&lt;&#x2F;span&gt;&lt;span&gt;) as released
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;FROM&lt;&#x2F;span&gt;&lt;span&gt;     racoons r
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;GROUP BY &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;r&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;caretaker_id&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;kb.objectrocket.com&#x2F;postgresql&#x2F;how-to-use-the-filter-clause-in-postgresql-881&quot;&gt;This page&lt;&#x2F;a&gt; has a bit more information, especially if you&#x27;re working with a PostgreSQL database prior to 9.4.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: Troubleshooting Mnesia</title>
          <pubDate>Wed, 11 Nov 2020 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20201111-elixir-troubleshooting-mnesia/</link>
          <guid>https://mbuffa.github.io/articles/20201111-elixir-troubleshooting-mnesia/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20201111-elixir-troubleshooting-mnesia/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;Mnesia is a powerful DBMS implemented in Erlang which you can use in your Elixir application.&lt;&#x2F;p&gt;
&lt;p&gt;Why would you want to do that?&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;It can span over multiple nodes in your cluster, providing redundancy and recovery mechanisms.&lt;&#x2F;li&gt;
&lt;li&gt;It prevents you from adding an external dependency like Redis, PostgreSQL, or whatever.&lt;&#x2F;li&gt;
&lt;li&gt;It provides all the features you need from a solid DBMS like transactions, locks, indices, dumps to disk, and a consistent data structure.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;After looking at and evaluating alternatives when working on a project at Pandascore, I finally decided to give a shot at Mnesia for storing an internal state. It took me a few hours to set it up correctly, but I ran into several issues that may drive anyone nearing an end of sprint crazy, so here&#x27;s a few tips for it :-)&lt;&#x2F;p&gt;
&lt;p&gt;One disclaimer though: this project is in production (\o&#x2F;), but due to other priorities, I&#x27;m not really monitoring it or improving the design, and thus learning more about Mnesia.&lt;&#x2F;p&gt;
&lt;p&gt;So this is pretty much a beginner to beginner feedback. Please take it with a pinch of salt.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;some-useful-links&quot;&gt;Some useful links&lt;&#x2F;h2&gt;
&lt;p&gt;Since I&#x27;m pretty much writing an addendum, you&#x27;ll find more exhaustive information with the following articles and resources. You can read them afterwards if you prefer, and go back to this article if you encounter any issue.&lt;&#x2F;p&gt;
&lt;p&gt;First, &lt;a href=&quot;https:&#x2F;&#x2F;www.welcometothejungle.com&#x2F;fr&#x2F;articles&#x2F;redis-mnesia-distributed-database&quot;&gt;this excellent article from Welcome to the Jungle&lt;&#x2F;a&gt; gave me a good overview on how to setup Mnesia in a cluster.&lt;&#x2F;p&gt;
&lt;p&gt;Two more links are mentioned at the end of this article, but I&#x27;ll paste them here too. &lt;a href=&quot;https:&#x2F;&#x2F;elixirschool.com&#x2F;en&#x2F;lessons&#x2F;specifics&#x2F;mnesia&quot;&gt;Elixir School has a good walkthrough&lt;&#x2F;a&gt; from begin to end mostly, and of course, &lt;a href=&quot;http:&#x2F;&#x2F;erlang.org&#x2F;doc&#x2F;man&#x2F;mnesia.html&quot;&gt;the Erlang documentation&lt;&#x2F;a&gt; is a gold mine, though it can be a bit rough to read if you&#x27;re well-versed in Elixir but not Erlang.&lt;&#x2F;p&gt;
&lt;p&gt;You can also check &lt;a href=&quot;&#x2F;tips&#x2F;20201022-elixir-clustering-on-kubernetes&#x2F;&quot;&gt;my article on deploying an Elixir cluster on Kubernetes&lt;&#x2F;a&gt; since I give a few details on how to set up a simple local cluster. I&#x27;ll do it more quickly here anyway.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;let-s-create-a-sample-project&quot;&gt;Let&#x27;s create a sample project&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s create a simple project to try out Mnesia locally. We&#x27;ll need to run a small cluster, so we&#x27;ll throw in one specific library.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;$ mix new clustertest
&lt;&#x2F;span&gt;&lt;span&gt;$ cd clustertest
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And let&#x27;s head out to &lt;code&gt;mix.exs&lt;&#x2F;code&gt; to add &lt;code&gt;libcluster&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In mix.exs
&lt;&#x2F;span&gt;&lt;span&gt;defp deps do
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    {:libcluster, &amp;quot;~&amp;gt; 3.2.1&amp;quot;},
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And let&#x27;s define a very simple Supervisor. This will get our ClusterSupervisor
started, with a simple configuration for our local experiments!&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In mix.exs:
&lt;&#x2F;span&gt;&lt;span&gt;def application do
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    mod: {Clustertest.Application, []},
&lt;&#x2F;span&gt;&lt;span&gt;    extra_applications: [:logger]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;# In lib&#x2F;clustertest&#x2F;application.ex
&lt;&#x2F;span&gt;&lt;span&gt;defmodule Clustertest.Application do
&lt;&#x2F;span&gt;&lt;span&gt;  use Application
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def start(_type, _args) do
&lt;&#x2F;span&gt;&lt;span&gt;    topologies = [
&lt;&#x2F;span&gt;&lt;span&gt;      epmd_example: [
&lt;&#x2F;span&gt;&lt;span&gt;        strategy: Cluster.Strategy.Epmd,
&lt;&#x2F;span&gt;&lt;span&gt;        config: [
&lt;&#x2F;span&gt;&lt;span&gt;          hosts: [:&amp;quot;a@127.0.0.1&amp;quot;, :&amp;quot;b@127.0.0.1&amp;quot;]
&lt;&#x2F;span&gt;&lt;span&gt;        ]
&lt;&#x2F;span&gt;&lt;span&gt;      ]
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    [
&lt;&#x2F;span&gt;&lt;span&gt;      {Cluster.Supervisor, [topologies, [name: Clustertest.ClusterSupervisor]]}
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;    |&amp;gt; Supervisor.start_link(strategy: :one_for_one)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will get you started with a small cluster of two nodes. &lt;code&gt;Epmd&lt;&#x2F;code&gt; is
perfectly fit for our example here, since we just have to specify a few hosts.&lt;&#x2F;p&gt;
&lt;p&gt;Now, let&#x27;s open two shells and start two instances:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In one shell
&lt;&#x2F;span&gt;&lt;span&gt;iex --name a@127.0.0.1 -S mix
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;# In another one
&lt;&#x2F;span&gt;&lt;span&gt;iex --name b@127.0.0.1 -S mix
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, running &lt;code&gt;Node.list()&lt;&#x2F;code&gt; in each REPL should give you exactly one atom:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; [:&amp;quot;b@127.0.0.1&amp;quot;]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; [:&amp;quot;a@127.0.0.1&amp;quot;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;initializing-mnesia&quot;&gt;Initializing Mnesia&lt;&#x2F;h2&gt;
&lt;p&gt;Now, let&#x27;s start actually using Mnesia. We&#x27;ll pretend we&#x27;re running a small wildlife protection office taking care of local racoons.&lt;&#x2F;p&gt;
&lt;p&gt;Also, for the sake of simplicity, we&#x27;ll add it directly to the children of our app. There&#x27;s no need for complexity for hello world code :)&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In lib&#x2F;clustertest&#x2F;application.ex
&lt;&#x2F;span&gt;&lt;span&gt;defmodule Clustertest.Application do
&lt;&#x2F;span&gt;&lt;span&gt;  use Application
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def start(_type, _args) do
&lt;&#x2F;span&gt;&lt;span&gt;    topologies = [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    [
&lt;&#x2F;span&gt;&lt;span&gt;      {Cluster.Supervisor, [topologies, [name: Clustertest.ClusterSupervisor]]},
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;      {Clustertest.Store.Racoon, []},
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;    |&amp;gt; Supervisor.start_link(strategy: :one_for_one)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;# In lib&#x2F;clustertest&#x2F;store&#x2F;racoon.ex
&lt;&#x2F;span&gt;&lt;span&gt;defmodule Clustertest.Store.Racoon do
&lt;&#x2F;span&gt;&lt;span&gt;  use GenServer
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def start_link(opts \\ []) do
&lt;&#x2F;span&gt;&lt;span&gt;    GenServer.start_link(__MODULE__, %{}, opts)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def init(state) do
&lt;&#x2F;span&gt;&lt;span&gt;    setup_store()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:ok, state}
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp setup_store() do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Setting up store...&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = ensure_schema_exists()
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = :mnesia.start()
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = ensure_table_exists()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;...Store set up!&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_schema_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    case :mnesia.create_schema([node()]) do
&lt;&#x2F;span&gt;&lt;span&gt;      {:error, {_node, {:already_exists, __node}}} -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        :ok
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;      :ok -&amp;gt; :ok
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_table_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    :mnesia.create_table(
&lt;&#x2F;span&gt;&lt;span&gt;      Racoon,
&lt;&#x2F;span&gt;&lt;span&gt;      [
&lt;&#x2F;span&gt;&lt;span&gt;        attributes: [
&lt;&#x2F;span&gt;&lt;span&gt;          :id,
&lt;&#x2F;span&gt;&lt;span&gt;          :name,
&lt;&#x2F;span&gt;&lt;span&gt;          :caretaker_id
&lt;&#x2F;span&gt;&lt;span&gt;        ]
&lt;&#x2F;span&gt;&lt;span&gt;      ]
&lt;&#x2F;span&gt;&lt;span&gt;    )
&lt;&#x2F;span&gt;&lt;span&gt;    |&amp;gt; case do
&lt;&#x2F;span&gt;&lt;span&gt;      {:atomic, :ok} -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        :ok
&lt;&#x2F;span&gt;&lt;span&gt;      {:aborted, {:already_exists, Racoon}} -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        :ok
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = :mnesia.wait_for_tables([Racoon], 5000)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There are a few important things to note here.&lt;&#x2F;p&gt;
&lt;p&gt;First, you &lt;em&gt;need&lt;&#x2F;em&gt; to create a schema &lt;em&gt;before&lt;&#x2F;em&gt; starting Mnesia. This is really important. Try switching the two lines to see what happens.&lt;&#x2F;p&gt;
&lt;p&gt;Then, you&#x27;re free to create your table. Both schema and table can be already created when you run your app, since Mnesia keeps RAM and disk copies, depending on how you configure it. By the way, you should have noticed there are now two new folders in your project directory:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;$ ls
&lt;&#x2F;span&gt;&lt;span&gt;Mnesia.a@127.0.0.1
&lt;&#x2F;span&gt;&lt;span&gt;Mnesia.b@127.0.0.1
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Hmm, let&#x27;s see if Mnesia is properly configured. Type this in a terminal:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;$ :mnesia.info()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will be your best friend for debugging Mnesia :)&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;---&amp;gt; Processes holding locks &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Processes waiting for locks &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Participant transactions &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Coordinator transactions &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Uncertain transactions &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Active tables &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;Elixir.Racoon  : with 0        records occupying 305      words of mem
&lt;&#x2F;span&gt;&lt;span&gt;schema         : with 2        records occupying 535      words of mem
&lt;&#x2F;span&gt;&lt;span&gt;===&amp;gt; System info in version &amp;quot;4.17&amp;quot;, debug level = none &amp;lt;===
&lt;&#x2F;span&gt;&lt;span&gt;opt_disc. Directory &amp;quot;&#x2F;home&#x2F;makks&#x2F;code&#x2F;mbuffa&#x2F;clustertest&#x2F;Mnesia.a@127.0.0.1&amp;quot; is used.
&lt;&#x2F;span&gt;&lt;span&gt;use fallback at restart = false
&lt;&#x2F;span&gt;&lt;span&gt;running db nodes   = [&amp;#39;a@127.0.0.1&amp;#39;]
&lt;&#x2F;span&gt;&lt;span&gt;stopped db nodes   = []
&lt;&#x2F;span&gt;&lt;span&gt;master node tables = []
&lt;&#x2F;span&gt;&lt;span&gt;remote             = []
&lt;&#x2F;span&gt;&lt;span&gt;ram_copies         = [&amp;#39;Elixir.Racoon&amp;#39;]
&lt;&#x2F;span&gt;&lt;span&gt;disc_copies        = [schema]
&lt;&#x2F;span&gt;&lt;span&gt;disc_only_copies   = []
&lt;&#x2F;span&gt;&lt;span&gt;[{&amp;#39;a@127.0.0.1&amp;#39;,disc_copies}] = [schema]
&lt;&#x2F;span&gt;&lt;span&gt;[{&amp;#39;a@127.0.0.1&amp;#39;,ram_copies}] = [&amp;#39;Elixir.Racoon&amp;#39;]
&lt;&#x2F;span&gt;&lt;span&gt;3 transactions committed, 0 aborted, 0 restarted, 2 logged to disc
&lt;&#x2F;span&gt;&lt;span&gt;0 held locks, 0 in queue; 0 local transactions, 0 remote
&lt;&#x2F;span&gt;&lt;span&gt;0 transactions waits for other nodes: []
&lt;&#x2F;span&gt;&lt;span&gt;:ok
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Hmm, looking at &lt;code&gt;running db nodes&lt;&#x2F;code&gt;, we&#x27;re only running two Mnesia nodes independently. We want to connect them, but we have to do it ourselves when new nodes are connected.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s go back to our Store and add a bit of code:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;We want to be notified when new nodes connect...&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;defmodule Clustertest.Store.Racoon do
&lt;&#x2F;span&gt;&lt;span&gt;  use GenServer
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def init(state) do
&lt;&#x2F;span&gt;&lt;span&gt;    # Get notified when new nodes are connected.
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = :net_kernel.monitor_nodes(true)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    setup_store()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:ok, state}
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ul&gt;
&lt;li&gt;...And we want to configure Mnesia to use extra nodes, create a table copy on the other node, and remove the other node when connection is lost.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;defmodule Clustertest.Store.Racoon do
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def handle_info({:nodeup, node}, state) do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Node connected: #{inspect node}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = connect_mnesia_to_cluster()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:noreply, state}
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def handle_info({:nodedown, node}, state) do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Node disconnected: #{inspect node}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    update_mnesia_nodes()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:noreply, state}
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp connect_mnesia_to_cluster() do
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = :mnesia.start()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:ok, [_|_] = nodes} = :mnesia.change_config(:extra_db_nodes, Node.list())
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Extra db nodes: #{ inspect nodes }&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = ensure_table_exists()
&lt;&#x2F;span&gt;&lt;span&gt;    :mnesia.change_table_copy_type(:schema, node(), :disc_copies)
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = ensure_table_copy_exists()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Successfully connected Mnesia to the cluster!&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    :ok
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp update_mnesia_nodes do
&lt;&#x2F;span&gt;&lt;span&gt;    nodes = Node.list()
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Updating Mnesia nodes with #{inspect nodes}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;    :mnesia.change_config(:extra_db_nodes, nodes)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_schema_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    [...]
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_table_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    [...]
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_table_copy_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    case :mnesia.add_table_copy(Racoon, node(), :disc_copies) do
&lt;&#x2F;span&gt;&lt;span&gt;      {:atomic, :ok} -&amp;gt; :ok
&lt;&#x2F;span&gt;&lt;span&gt;      {:aborted, {:already_exists, Racoon, _node}} -&amp;gt; :ok
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, restarting our two nodes should raise an error:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;17:20:34.541 [error] GenServer #PID&amp;lt;0.213.0&amp;gt; terminating
&lt;&#x2F;span&gt;&lt;span&gt;** (MatchError) no match of right hand side value: {:ok, []}
&lt;&#x2F;span&gt;&lt;span&gt;    (clustertest 0.1.0) lib&#x2F;clustertest&#x2F;store&#x2F;racoon.ex:46: Clustertest.Store.Racoon.connect_mnesia_to_cluster&#x2F;0
&lt;&#x2F;span&gt;&lt;span&gt;    (clustertest 0.1.0) lib&#x2F;clustertest&#x2F;store&#x2F;racoon.ex:30: Clustertest.Store.Racoon.handle_info&#x2F;2
&lt;&#x2F;span&gt;&lt;span&gt;    (stdlib 3.13) gen_server.erl:680: :gen_server.try_dispatch&#x2F;4
&lt;&#x2F;span&gt;&lt;span&gt;    (stdlib 3.13) gen_server.erl:756: :gen_server.handle_msg&#x2F;6
&lt;&#x2F;span&gt;&lt;span&gt;    (stdlib 3.13) proc_lib.erl:226: :proc_lib.init_p_do_apply&#x2F;3
&lt;&#x2F;span&gt;&lt;span&gt;Last message: {:nodeup, :&amp;quot;b@127.0.0.1&amp;quot;}
&lt;&#x2F;span&gt;&lt;span&gt;State: %{}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Why is &lt;code&gt;:mnesia.change_config(:extra_db_nodes, Node.list())&lt;&#x2F;code&gt; returning &lt;code&gt;:ok&lt;&#x2F;code&gt; with an empty array?&lt;&#x2F;p&gt;
&lt;p&gt;Well, you can&#x27;t really guess, and silent errors is why Mnesia can be difficult to work with for the first time.&lt;&#x2F;p&gt;
&lt;p&gt;In fact, Mnesia requires that you create an identical schema on each of your nodes, sharing the same cookie. By calling &lt;code&gt;setup_store()&lt;&#x2F;code&gt; and its &lt;code&gt;:mnesia.create_schema()&lt;&#x2F;code&gt;, you&#x27;re creating two conflicting schemas Mnesia can&#x27;t resolve.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s remove &lt;code&gt;setup_store()&lt;&#x2F;code&gt; completely (and &lt;code&gt;ensure_schema_exists()&lt;&#x2F;code&gt; too). If we need to be able to deploy single nodes (locally for example) we can still define an environment variable to decide what to do. But this is off-topic.&lt;&#x2F;p&gt;
&lt;p&gt;Also, remember those two folders that popped up in your directory? Remove those folders. Those may contain conflicting schemas.&lt;&#x2F;p&gt;
&lt;p&gt;Now, let&#x27;s restart our two REPLs.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;17:35:48.049 [error] GenServer #PID&amp;lt;0.213.0&amp;gt; terminating
&lt;&#x2F;span&gt;&lt;span&gt;** (MatchError) no match of right hand side value: {:ok, []}
&lt;&#x2F;span&gt;&lt;span&gt;    (clustertest 0.1.0) lib&#x2F;clustertest&#x2F;store&#x2F;racoon.ex:34: Clustertest.Store.Racoon.connect_mnesia_to_cluster&#x2F;0
&lt;&#x2F;span&gt;&lt;span&gt;    (clustertest 0.1.0) lib&#x2F;clustertest&#x2F;store&#x2F;racoon.ex:18: Clustertest.Store.Racoon.handle_info&#x2F;2
&lt;&#x2F;span&gt;&lt;span&gt;    (stdlib 3.13) gen_server.erl:680: :gen_server.try_dispatch&#x2F;4
&lt;&#x2F;span&gt;&lt;span&gt;    (stdlib 3.13) gen_server.erl:756: :gen_server.handle_msg&#x2F;6
&lt;&#x2F;span&gt;&lt;span&gt;    (stdlib 3.13) proc_lib.erl:226: :proc_lib.init_p_do_apply&#x2F;3
&lt;&#x2F;span&gt;&lt;span&gt;Last message: {:nodeup, :&amp;quot;b@127.0.0.1&amp;quot;}
&lt;&#x2F;span&gt;&lt;span&gt;State: %{}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Well, you can&#x27;t guess either, but Mnesia must be started as an application. Surprisingly enough, trying to use &lt;code&gt;:mnesia&lt;&#x2F;code&gt; functions wouldn&#x27;t raise any errors.&lt;&#x2F;p&gt;
&lt;p&gt;So let&#x27;s head to our manifest and add &lt;code&gt;:mnesia&lt;&#x2F;code&gt; in a familiar place:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In mix.exs
&lt;&#x2F;span&gt;&lt;span&gt;def application do
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    mod: {Clustertest.Application, []},
&lt;&#x2F;span&gt;&lt;span&gt;    extra_applications: [:logger, :mnesia]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now let&#x27;s check...&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;---&amp;gt; Processes holding locks &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Processes waiting for locks &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Participant transactions &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Coordinator transactions &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Uncertain transactions &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;---&amp;gt; Active tables &amp;lt;---
&lt;&#x2F;span&gt;&lt;span&gt;schema         : with 2        records occupying 554      words of mem
&lt;&#x2F;span&gt;&lt;span&gt;===&amp;gt; System info in version &amp;quot;4.17&amp;quot;, debug level = none &amp;lt;===
&lt;&#x2F;span&gt;&lt;span&gt;opt_disc. Directory &amp;quot;&#x2F;home&#x2F;makks&#x2F;code&#x2F;mbuffa&#x2F;clustertest&#x2F;Mnesia.a@127.0.0.1&amp;quot; is NOT used.
&lt;&#x2F;span&gt;&lt;span&gt;use fallback at restart = false
&lt;&#x2F;span&gt;&lt;span&gt;running db nodes   = [&amp;#39;b@127.0.0.1&amp;#39;,&amp;#39;a@127.0.0.1&amp;#39;]
&lt;&#x2F;span&gt;&lt;span&gt;stopped db nodes   = []
&lt;&#x2F;span&gt;&lt;span&gt;master node tables = []
&lt;&#x2F;span&gt;&lt;span&gt;remote             = [&amp;#39;Elixir.Racoon&amp;#39;]
&lt;&#x2F;span&gt;&lt;span&gt;ram_copies         = [schema]
&lt;&#x2F;span&gt;&lt;span&gt;disc_copies        = []
&lt;&#x2F;span&gt;&lt;span&gt;disc_only_copies   = []
&lt;&#x2F;span&gt;&lt;span&gt;[{&amp;#39;a@127.0.0.1&amp;#39;,ram_copies},{&amp;#39;b@127.0.0.1&amp;#39;,disc_copies}] = [schema]
&lt;&#x2F;span&gt;&lt;span&gt;[{&amp;#39;b@127.0.0.1&amp;#39;,ram_copies}] = [&amp;#39;Elixir.Racoon&amp;#39;]
&lt;&#x2F;span&gt;&lt;span&gt;2 transactions committed, 0 aborted, 0 restarted, 0 logged to disc
&lt;&#x2F;span&gt;&lt;span&gt;0 held locks, 0 in queue; 0 local transactions, 0 remote
&lt;&#x2F;span&gt;&lt;span&gt;0 transactions waits for other nodes: []
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;media.giphy.com&#x2F;media&#x2F;4xpB3eE00FfBm&#x2F;giphy.gif&quot; alt=&quot;&quot; title=&quot;hooray&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;See how &lt;code&gt;opt_disc&lt;&#x2F;code&gt; and &lt;code&gt;running db nodes&lt;&#x2F;code&gt; changed. But we have no data yet.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;inserting-data&quot;&gt;Inserting data&lt;&#x2F;h2&gt;
&lt;p&gt;We&#x27;ll add some code and make some changes so that we&#x27;ll use a struct defined in &lt;code&gt;Types.Racoon&lt;&#x2F;code&gt;. The naming in my example isn&#x27;t great, but basically, we&#x27;re just adding serialization&#x2F;deserialization functions to manipulate structs in our codebase, while Mnesia stores tuples.&lt;&#x2F;p&gt;
&lt;p&gt;So we&#x27;ll add two functions, &lt;code&gt;list()&lt;&#x2F;code&gt; and &lt;code&gt;create()&lt;&#x2F;code&gt;, and do a few changes on the table name.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;defmodule Clustertest.Store.Racoon do
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defmodule Types.Racoon do
&lt;&#x2F;span&gt;&lt;span&gt;    defstruct [
&lt;&#x2F;span&gt;&lt;span&gt;      :id,
&lt;&#x2F;span&gt;&lt;span&gt;      :name,
&lt;&#x2F;span&gt;&lt;span&gt;      caretaker_id: nil
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    def decode({__MODULE__, id, name, caretaker_id}) do
&lt;&#x2F;span&gt;&lt;span&gt;      %__MODULE__{
&lt;&#x2F;span&gt;&lt;span&gt;        id: id,
&lt;&#x2F;span&gt;&lt;span&gt;        name: name,
&lt;&#x2F;span&gt;&lt;span&gt;        caretaker_id: caretaker_id
&lt;&#x2F;span&gt;&lt;span&gt;      }
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    def encode(%__MODULE__{
&lt;&#x2F;span&gt;&lt;span&gt;      id: id,
&lt;&#x2F;span&gt;&lt;span&gt;      name: name,
&lt;&#x2F;span&gt;&lt;span&gt;      caretaker_id: caretaker_id
&lt;&#x2F;span&gt;&lt;span&gt;    }) do
&lt;&#x2F;span&gt;&lt;span&gt;      {__MODULE__, id, name, caretaker_id}
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def list() do
&lt;&#x2F;span&gt;&lt;span&gt;    {:atomic, list} = :mnesia.transaction(fn -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;      :mnesia.match_object({Types.Racoon, :_, :_, :_})
&lt;&#x2F;span&gt;&lt;span&gt;    end)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    list |&amp;gt; Enum.map(fn x -&amp;gt; Types.Racoon.decode(x) end)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def create(%Types.Racoon{ id: id } = state) when is_integer(id) do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Inserting #{inspect state}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:atomic, reason} = :mnesia.transaction(fn -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;      case :mnesia.read(Types.Racoon, id, :write) do
&lt;&#x2F;span&gt;&lt;span&gt;        [] -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          Types.Racoon.encode(state) |&amp;gt; :mnesia.write()
&lt;&#x2F;span&gt;&lt;span&gt;        _ -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          :record_exists
&lt;&#x2F;span&gt;&lt;span&gt;      end
&lt;&#x2F;span&gt;&lt;span&gt;    end)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    reason
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_table_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    :mnesia.create_table(
&lt;&#x2F;span&gt;&lt;span&gt;      Types.Racoon,
&lt;&#x2F;span&gt;&lt;span&gt;      [
&lt;&#x2F;span&gt;&lt;span&gt;        attributes: [
&lt;&#x2F;span&gt;&lt;span&gt;          :id,
&lt;&#x2F;span&gt;&lt;span&gt;          :name,
&lt;&#x2F;span&gt;&lt;span&gt;          :caretaker_id
&lt;&#x2F;span&gt;&lt;span&gt;        ]
&lt;&#x2F;span&gt;&lt;span&gt;      ]
&lt;&#x2F;span&gt;&lt;span&gt;    )
&lt;&#x2F;span&gt;&lt;span&gt;    |&amp;gt; case do
&lt;&#x2F;span&gt;&lt;span&gt;      {:atomic, :ok} -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        :ok
&lt;&#x2F;span&gt;&lt;span&gt;      {:aborted, {:already_exists, Types.Racoon}} -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        :ok
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    :ok = :mnesia.wait_for_tables([Types.Racoon], 5000)
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  defp ensure_table_copy_exists() do
&lt;&#x2F;span&gt;&lt;span&gt;    case :mnesia.add_table_copy(Types.Racoon, node(), :disc_copies) do
&lt;&#x2F;span&gt;&lt;span&gt;      {:atomic, :ok} -&amp;gt; :ok
&lt;&#x2F;span&gt;&lt;span&gt;      {:aborted, {:already_exists, Types.Racoon, _node}} -&amp;gt; :ok
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now let&#x27;s test a few examples, after a REPL reset.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In your first shell:
&lt;&#x2F;span&gt;&lt;span&gt;iex(a@127.0.0.1)3&amp;gt; Clustertest.Store.Racoon.list()
&lt;&#x2F;span&gt;&lt;span&gt;[]
&lt;&#x2F;span&gt;&lt;span&gt;iex(a@127.0.0.1)4&amp;gt; Clustertest.Store.Racoon.create(%Clustertest.Store.Racoon.Types.Racoon{ id: 1, name: &amp;quot;Ricky&amp;quot;, caretaker_id: nil })
&lt;&#x2F;span&gt;&lt;span&gt;Inserting %Clustertest.Store.Racoon.Types.Racoon{caretaker_id: nil, id: 1, name: &amp;quot;Ricky&amp;quot;}
&lt;&#x2F;span&gt;&lt;span&gt;:ok
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;# In your second shell:
&lt;&#x2F;span&gt;&lt;span&gt;iex(b@127.0.0.1)4&amp;gt; Clustertest.Store.Racoon.list()
&lt;&#x2F;span&gt;&lt;span&gt;[
&lt;&#x2F;span&gt;&lt;span&gt;  %Clustertest.Store.Racoon.Types.Racoon{
&lt;&#x2F;span&gt;&lt;span&gt;    caretaker_id: nil,
&lt;&#x2F;span&gt;&lt;span&gt;    id: 1,
&lt;&#x2F;span&gt;&lt;span&gt;    name: &amp;quot;Ricky&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;update&lt;&#x2F;code&gt;, &lt;code&gt;read&lt;&#x2F;code&gt;, and &lt;code&gt;delete&lt;&#x2F;code&gt; functions are quite straighforward. You can implement them yourself, but I&#x27;m adding those as a reference.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;defmodule Clustertest.Store.Racoon do
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def update(%Types.Racoon{ id: id } = new_state) when is_integer(id) do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Updating #{inspect new_state}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:atomic, reason} = :mnesia.transaction(fn -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;      [{Types.Racoon, ^id, _, _,}] = :mnesia.read(Types.Racoon, id, :write)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;      Types.Racoon.encode(new_state) |&amp;gt; :mnesia.write()
&lt;&#x2F;span&gt;&lt;span&gt;    end)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    reason
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def read(id) when is_integer(id) do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Returning #{id}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:atomic, result} = :mnesia.transaction(fn -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;      :mnesia.read(Types.Racoon, id, :read)
&lt;&#x2F;span&gt;&lt;span&gt;    end)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    case result do
&lt;&#x2F;span&gt;&lt;span&gt;      [] -&amp;gt; nil
&lt;&#x2F;span&gt;&lt;span&gt;      list -&amp;gt; list |&amp;gt; List.first() |&amp;gt; Types.Racoon.decode()
&lt;&#x2F;span&gt;&lt;span&gt;    end
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  def delete(id) when is_integer(id) do
&lt;&#x2F;span&gt;&lt;span&gt;    IO.puts(&amp;quot;Deleting #{id}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    {:atomic, :ok} = :mnesia.transaction(fn -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;      :ok = :mnesia.delete(Types.Racoon, id, :write)
&lt;&#x2F;span&gt;&lt;span&gt;    end)
&lt;&#x2F;span&gt;&lt;span&gt;    :ok
&lt;&#x2F;span&gt;&lt;span&gt;  end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  [...]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You can play around with this :) Note that creating data on one node, and creating the identical data on another node doesn&#x27;t raise any issue, but do not create duplicates either.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s one issue remaining though: closing both REPLs clear the table. This is because we forgot to specify one option when calling &lt;code&gt;:mnesia.create_table&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;:mnesia.create_table(
&lt;&#x2F;span&gt;&lt;span&gt;  Types.Racoon,
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    attributes: [
&lt;&#x2F;span&gt;&lt;span&gt;      :id,
&lt;&#x2F;span&gt;&lt;span&gt;      :name,
&lt;&#x2F;span&gt;&lt;span&gt;      :caretaker_id
&lt;&#x2F;span&gt;&lt;span&gt;    ],
&lt;&#x2F;span&gt;&lt;span&gt;    disc_copies: [Node.self()]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now we&#x27;re good, and &lt;code&gt;:mnesia.info()&lt;&#x2F;code&gt; doesn&#x27;t show an empty &lt;code&gt;disc_copies&lt;&#x2F;code&gt; anymore.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-few-important-notes-for-releases&quot;&gt;A few important notes for releases...&lt;&#x2F;h2&gt;
&lt;p&gt;...and solving the &quot;bad cookie&quot; issue.&lt;&#x2F;p&gt;
&lt;p&gt;Keep in mind that we&#x27;ve been using &lt;code&gt;iex&lt;&#x2F;code&gt; all along and that running a compiled application will raise a few differences.&lt;&#x2F;p&gt;
&lt;p&gt;Remember the snippet I used for adding &lt;code&gt;:mnesia&lt;&#x2F;code&gt; to our running application?&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In mix.exs
&lt;&#x2F;span&gt;&lt;span&gt;def application do
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    mod: {Clustertest.Application, []},
&lt;&#x2F;span&gt;&lt;span&gt;    extra_applications: [:logger, :mnesia]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;media.giphy.com&#x2F;media&#x2F;11CCn8sSFSm2kg&#x2F;giphy.gif&quot; alt=&quot;&quot; title=&quot;I lied.&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Well, it might cause you some trouble once you compile your release with &lt;code&gt;mix release&lt;&#x2F;code&gt; and your node starts.&lt;&#x2F;p&gt;
&lt;p&gt;Thing is, adding libraries to &lt;code&gt;extra_applications&lt;&#x2F;code&gt; would start them automatically before your application does, so we have to specify
that we only want to reference it in our release, to avoid :mnesia creating a schema and starting automatically.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# In mix.exs
&lt;&#x2F;span&gt;&lt;span&gt;def application do
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    mod: {Clustertest.Application, []},
&lt;&#x2F;span&gt;&lt;span&gt;    extra_applications: [:logger],
&lt;&#x2F;span&gt;&lt;span&gt;    included_applications: [:mnesia]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Thing is, I also had to revert my changes on &lt;code&gt;create_table&lt;&#x2F;code&gt; and remove the &lt;code&gt;disc_copies&lt;&#x2F;code&gt; option.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;:mnesia.create_table(
&lt;&#x2F;span&gt;&lt;span&gt;  Types.Racoon,
&lt;&#x2F;span&gt;&lt;span&gt;  [
&lt;&#x2F;span&gt;&lt;span&gt;    attributes: [
&lt;&#x2F;span&gt;&lt;span&gt;      :id,
&lt;&#x2F;span&gt;&lt;span&gt;      :name,
&lt;&#x2F;span&gt;&lt;span&gt;      :caretaker_id
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, &lt;code&gt;:mnesia.info()&lt;&#x2F;code&gt; will properly display a populated &lt;code&gt;disc_copies&lt;&#x2F;code&gt; option.&lt;&#x2F;p&gt;
&lt;p&gt;I do not know why those differences between &lt;code&gt;iex&lt;&#x2F;code&gt; and compiled code exist. I may be doing something wrong, so please feel free to open an issue on the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mbuffa&#x2F;elixir-mnesia-example&quot;&gt;repository&lt;&#x2F;a&gt; if you find why!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;I hope this was neither too tedious or frightening regarding the usage of Mnesia in your project. I thought the &quot;crash course&quot; format to be interesting in this case (ie. amending snippets), because it helps to have beaten that path when things go wrong.&lt;&#x2F;p&gt;
&lt;p&gt;I didn&#x27;t mention the issue of network partitioning and a possible way to solve it, but this is more related to your cluster configuration. Essentially, network failure may happen inside your cluster, and reconnecting nodes wouldn&#x27;t know how to handle this, since we&#x27;re not using a master-replica strategy. I haven&#x27;t read much about this, but one possible solution would be to pass the cluster size as an environment variable to all nodes, and check the &lt;code&gt;Node.list()&lt;&#x2F;code&gt; result when a &lt;code&gt;:nodedown&lt;&#x2F;code&gt; message is received. Afterwards, a simple calculation should be enough to determine if your node is isolated or in a dominant group, allowing you to push the self-destruct red button with, for example, a &quot;liveness&quot; GenServer exposed to your orchestrator, returning &lt;code&gt;HTTP 200 Ok&lt;&#x2F;code&gt; responses codes until isolation is detected.&lt;&#x2F;p&gt;
&lt;p&gt;Note that there&#x27;s also the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;beardedeagle&#x2F;mnesiac&quot;&gt;Mnesiac&lt;&#x2F;a&gt; library, which is an Elixir layer on top of Mnesia. I prefer using low-level libraries directly, at least for learning, but it might be a good fit for production though.&lt;&#x2F;p&gt;
&lt;p&gt;Last, but not least, I &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mbuffa&#x2F;elixir-mnesia-example&quot;&gt;created a repository&lt;&#x2F;a&gt; with a small and clear commit history, in case you want to tinker with it.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;Et voil.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Elixir: Clustering on Kubernetes</title>
          <pubDate>Wed, 21 Oct 2020 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20201022-elixir-clustering-on-kubernetes/</link>
          <guid>https://mbuffa.github.io/articles/20201022-elixir-clustering-on-kubernetes/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20201022-elixir-clustering-on-kubernetes/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;When developing Elixir applications, you may want to create a cluster of Erlang nodes at some point, for example, to provide redundancy, high availability,or to share a global state on the cluster (with Mnesia, for example) without hitting an outside DBMS.&lt;&#x2F;p&gt;
&lt;p&gt;This can be easily achieved with &lt;code&gt;libcluster&lt;&#x2F;code&gt;. As you can see &lt;a href=&quot;https:&#x2F;&#x2F;hexdocs.pm&#x2F;libcluster&#x2F;readme.html&quot;&gt;in the docs&lt;&#x2F;a&gt;, it supports multiple strategies.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ll assume you want to deploy to a Kubernetes cluster, and I&#x27;ll be covering this strategy only (&lt;code&gt;Cluster.Strategy.Kubernetes&lt;&#x2F;code&gt;) for simplicity sake, but you may find some bits interesting even if that doesn&#x27;t apply to your case. I&#x27;ll also assume that you already have a working basic Kubernetes deployment setup.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;ll deploy a &lt;code&gt;cluster&lt;&#x2F;code&gt; of Erlang &lt;code&gt;nodes&lt;&#x2F;code&gt;. To avoid confusion with Kubernetes terminology, I&#x27;ll use the prefix &lt;code&gt;k8s&lt;&#x2F;code&gt; when referring to Kube.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-word-about-wsl&quot;&gt;A word about WSL&lt;&#x2F;h2&gt;
&lt;p&gt;You may run into one issue if you&#x27;re using WSL: by default, WSL systems use the same hostname as their Windows host, which isn&#x27;t fully qualified, and Erlang may not like that.&lt;&#x2F;p&gt;
&lt;p&gt;To fix this (and to avoid breaking WSL), you can specify a full computer name on Windows.&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Go to your PC settings (&lt;code&gt;This PC&lt;&#x2F;code&gt; -&amp;gt; &lt;code&gt;Properties&lt;&#x2F;code&gt; -&amp;gt; &lt;code&gt;Change Settings&lt;&#x2F;code&gt; -&amp;gt; &lt;code&gt;Change&lt;&#x2F;code&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;In the &lt;code&gt;Computer&#x2F;Domain Changes&lt;&#x2F;code&gt; window, keep a simple Computer Name,&lt;&#x2F;li&gt;
&lt;li&gt;Click on More, and in the &lt;code&gt;DNS Suffix and NetBIOS Computer Name&lt;&#x2F;code&gt; window, specify a primary DNS suffix (like &lt;code&gt;localdomain&lt;&#x2F;code&gt;).&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;You can keep the other settings unchanged, provided you have something like &lt;code&gt;barney&lt;&#x2F;code&gt; as computer name and &lt;code&gt;barney.localdomain&lt;&#x2F;code&gt; as full computer name.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;connecting-nodes-locally&quot;&gt;Connecting nodes locally&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s make a new clean project with Mix:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; mix new cluster
&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; cd cluster
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And let&#x27;s start a &lt;code&gt;iex&lt;&#x2F;code&gt; REPL, giving it a new argument:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; iex --sname a
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, we just passed a flag to the Erlang VM, specifying the shortname of the node we want to run.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s now a slight difference appearing in your prompt:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;iex(a@{HOSTNAME})1&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You should see your PC hostname at the right of that &lt;code&gt;@&lt;&#x2F;code&gt; symbol. This is a default value, because we haven&#x27;t specified a fully qualified name.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s start a second Elixir app, in another terminal:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; iex --sname b
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And let&#x27;s discover a few functions!&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;node()&lt;&#x2F;code&gt; (or &lt;code&gt;Node.self()&lt;&#x2F;code&gt;) returns the name of the current Node.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;Node.list()&lt;&#x2F;code&gt; returns a list of the connected Nodes in the cluster. At this point, it should be empty.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;Node.connect()&lt;&#x2F;code&gt; and &lt;code&gt;Node.disconnect()&lt;&#x2F;code&gt; allow you to, you guessed it, connect and disconnect nodes. Let&#x27;s try it!&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;On the &lt;code&gt;b&lt;&#x2F;code&gt; Node, type:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;Node.connect(:a@hostname)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, go back to the &lt;code&gt;a&lt;&#x2F;code&gt; Node, and run:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;Node.list()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You should see &lt;code&gt;b@hostname&lt;&#x2F;code&gt; appearing there. Congratulations :) We haven&#x27;t done anything spectacular this far, but this is exactly what &lt;code&gt;libcluster&lt;&#x2F;code&gt; will do under the hood once it&#x27;s set up correctly.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;todo&quot;&gt;Todo&lt;&#x2F;h2&gt;
&lt;p&gt;So, here&#x27;s what we&#x27;ll have to do:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Pass the relevant fully qualified name to each Erlang VM&lt;&#x2F;li&gt;
&lt;li&gt;Update our Kubernetes configuration&lt;&#x2F;li&gt;
&lt;li&gt;Define a cluster topology to configure &lt;code&gt;libcluster&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h2 id=&quot;vm-args&quot;&gt;VM Args&lt;&#x2F;h2&gt;
&lt;p&gt;We&#x27;ll need to pass some arguments to our Erlang VMs.
Since at least its version &lt;code&gt;1.10&lt;&#x2F;code&gt;, Mix can handle this (you won&#x27;t need to add Distillery as a dependency).&lt;&#x2F;p&gt;
&lt;p&gt;In your project directory, run:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;mix release.init
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This command will generate a few files. Let&#x27;s take a look at &lt;code&gt;vm.args.eex&lt;&#x2F;code&gt;. It should contain a few commented lines, specifically:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;## Customize flags given to the VM: http:&#x2F;&#x2F;erlang.org&#x2F;doc&#x2F;man&#x2F;erl.html
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;## -mode&#x2F;-name&#x2F;-sname&#x2F;-setcookie are configured via env vars, do not set them here
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Since we want to set &lt;code&gt;name&lt;&#x2F;code&gt; and deploy on Linux containers, let&#x27;s get to &lt;code&gt;env.sh.eex&lt;&#x2F;code&gt;. There&#x27;s a few commented lines in there, but we&#x27;re most interested in the last block:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# Set the release to work across nodes. If using the long name format like
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# the one below (my_app@127.0.0.1), you need to also uncomment the
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# RELEASE_DISTRIBUTION variable below. Must be &amp;quot;sname&amp;quot;, &amp;quot;name&amp;quot; or &amp;quot;none&amp;quot;.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# export RELEASE_DISTRIBUTION=name
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# export RELEASE_NODE=&amp;lt;%= @release.name %&amp;gt;@127.0.0.1
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To enable clustering, we need to replace the &lt;code&gt;127.0.0.1&lt;&#x2F;code&gt; part with the fully qualified name of our pod. Kubernetes has its own internal DNS, and pods are typically named like this:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;# Assuming our Pod IP is 192.168.0.45
&lt;&#x2F;span&gt;&lt;span&gt;192-168-0-45.namespace.pod.cluster.local
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So your setup should end up looking like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;POD_A_RECORD&lt;&#x2F;span&gt;&lt;span&gt;=$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;echo &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;POD_IP &lt;&#x2F;span&gt;&lt;span&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;sed &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;s&#x2F;\.&#x2F;-&#x2F;g&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;RELEASE_DISTRIBUTION&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;name
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;RELEASE_NODE&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;myapp@&lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;echo &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;POD_A_RECORD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;).&lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;echo &lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;NAMESPACE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;).pod.cluster.local
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Both &lt;code&gt;$POD_IP&lt;&#x2F;code&gt; and &lt;code&gt;$NAMESPACE&lt;&#x2F;code&gt; will have to be defined when our application starts, so we&#x27;ll add those to our k8s deployment manifest.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;kubernetes-configuration&quot;&gt;Kubernetes configuration&lt;&#x2F;h2&gt;
&lt;p&gt;We should now declare our two new environment variables:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;apiVersion&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;apps&#x2F;v1
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;kind&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Deployment
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;myapp
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;namespace&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;default
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;selector&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;matchLabels&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;myapp
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;tier&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;web
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;template&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;myapp
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;tier&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;web
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;containers&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;myapp
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;image&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;lt;Image&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;resources&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;limits&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span&gt;: &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;128Mi&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cpu&lt;&#x2F;span&gt;&lt;span&gt;: &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;500m&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;ports&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;containerPort&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;lt;Port&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;env&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;NAMESPACE
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;valueFrom&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fieldRef&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fieldPath&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;metadata.namespace
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;name&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;POD_IP
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;valueFrom&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fieldRef&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;fieldPath&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;status.podIP
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Both variables references the pod&#x27;s information once it&#x27;s started. You can check it by running:e by running:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;kubectl get pod myapp-456789 -o yaml
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you already have one pod correctly labelled, you can check that libcluster will correctly poll the right pods from Kube by doing what it does: polling with a labelSelector:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;kubectl get pods -l app=myapp,tier=web
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If this returns off-topic pods, then you should fix this before proceeding :)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;libcluster-topology&quot;&gt;Libcluster topology&lt;&#x2F;h2&gt;
&lt;p&gt;Last, but not least, we need to specify our libcluster strategy:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span&gt;topologies = [
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;default: &lt;&#x2F;span&gt;&lt;span&gt;[
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;strategy: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Cluster&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Strategy&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Kubernetes&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;config: &lt;&#x2F;span&gt;&lt;span&gt;[
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;mode: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:dns&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;kubernetes_node_basename: &lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;myapp&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;kubernetes_selector: &lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;app=myapp,tier=web&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;kubernetes_namespace: &lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;default&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;polling_interval: 10_000
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;  ]
&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[
&lt;&#x2F;span&gt;&lt;span&gt;  {&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Cluster&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Supervisor&lt;&#x2F;span&gt;&lt;span&gt;, [topologies, [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;name: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Myapp&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;ClusterSupervisor&lt;&#x2F;span&gt;&lt;span&gt;]]}
&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once you deploy this, you should be good :) After scaling up your deployment (&lt;code&gt;kubectl scale --replicas=X deployment&#x2F;my-app&lt;&#x2F;code&gt;), you should see various &lt;code&gt;[libcluster]&lt;&#x2F;code&gt; log entries on your pods.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-now&quot;&gt;What now?&lt;&#x2F;h2&gt;
&lt;p&gt;There&#x27;s a few things to toy around with if you want to leverage your cluster!&lt;&#x2F;p&gt;
&lt;p&gt;Starting from there, and after cleaning your configuration and&#x2F;or setting up cleaner environment variables, there are a few interesting things to do. How about:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Declaring a GenServer tracking nodes status?&lt;&#x2F;li&gt;
&lt;li&gt;Implementing a Cluster Singleton worker using &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Virviil&#x2F;individual&quot;&gt;Individual&lt;&#x2F;a&gt;?&lt;&#x2F;li&gt;
&lt;li&gt;Toying around with Phoenix.PubSub?&lt;&#x2F;li&gt;
&lt;li&gt;Playing with process registries, like Phoenix.Tracker?&lt;&#x2F;li&gt;
&lt;li&gt;Discovering Erlang&#x27;s &lt;a href=&quot;http:&#x2F;&#x2F;erlang.org&#x2F;doc&#x2F;apps&#x2F;mnesia&#x2F;Mnesia_chap2.html&quot;&gt;Mnesia&lt;&#x2F;a&gt;, a powerful in-cluster DBMS to use for internal state or cache, and which makes Redis irrelevant?&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;node-up-down-notifications&quot;&gt;Node up&#x2F;down notifications&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a href=&quot;http:&#x2F;&#x2F;erlang.org&#x2F;doc&#x2F;man&#x2F;net_kernel.html#monitor_nodes-1&quot;&gt;Erlang exposes a simple function&lt;&#x2F;a&gt; that&#x27;ll get the current process notified when nodes are up or down. This can allow us to react accordingly, like printing debug information in the logs, dereferencing the node, or push the self destruct button.&lt;&#x2F;p&gt;
&lt;p&gt;In our first example, if you had run the following before connecting the two nodes together:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:net_kernel&lt;&#x2F;span&gt;&lt;span&gt;.monitor_nodes(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;true&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then running &lt;code&gt;flush&lt;&#x2F;code&gt; would show you the messages you received:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:nodeup&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:a@Hostname&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You can call &lt;code&gt;monitor_nodes&lt;&#x2F;code&gt; in a &lt;a href=&quot;https:&#x2F;&#x2F;elixir-lang.org&#x2F;getting-started&#x2F;mix-otp&#x2F;genserver.html&quot;&gt;GenServer&lt;&#x2F;a&gt;, of course, and implement the relevant callbacks:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;elixir&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-elixir &quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;handle_info&lt;&#x2F;span&gt;&lt;span&gt;({&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:nodeup&lt;&#x2F;span&gt;&lt;span&gt;, node}, state) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;IO&lt;&#x2F;span&gt;&lt;span&gt;.puts(&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;[STORE] Node connected: #{&lt;&#x2F;span&gt;&lt;span&gt;inspect node}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;  {&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:noreply&lt;&#x2F;span&gt;&lt;span&gt;, state}
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;handle_info&lt;&#x2F;span&gt;&lt;span&gt;({&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:nodedown&lt;&#x2F;span&gt;&lt;span&gt;, node}, state) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;IO&lt;&#x2F;span&gt;&lt;span&gt;.puts(&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;[STORE] Node disconnected: #{&lt;&#x2F;span&gt;&lt;span&gt;inspect node}&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;  {&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;:noreply&lt;&#x2F;span&gt;&lt;span&gt;, state}
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;This article is a bit long and rough around the edges, but it should give you a better understanding on how to deploy Elixir applications as a cluster.&lt;&#x2F;p&gt;
&lt;p&gt;I strongly suggest that you follow the official documentations of Elixir, Erlang and libraries. The snippets I included may get outdated over time, though I don&#x27;t expect the process to be easier than it currently is :)&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Developing on WSL</title>
          <pubDate>Sun, 16 Aug 2020 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20200816-developing-on-wsl/</link>
          <guid>https://mbuffa.github.io/articles/20200816-developing-on-wsl/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20200816-developing-on-wsl/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;The latest versions of Windows 10 have seen the maturation of WSL, the Windows Subsystem for Linux. Basically, it allows installing a Linux distribution that&#x27;ll use a special Linux kernel running &quot;nativaly&quot; on Windows 10. It doesn&#x27;t run on a virtualized environment, although it seems to use a Hyper-V volume for storage.&lt;&#x2F;p&gt;
&lt;p&gt;Oh, and you can also use their shiny new &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;microsoft&#x2F;terminal&quot;&gt;Terminal&lt;&#x2F;a&gt; for ultimate ease of use.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-good&quot;&gt;The Good&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;seamless-development&quot;&gt;Seamless development&lt;&#x2F;h3&gt;
&lt;p&gt;You will evolve in a familiar environment if you&#x27;re already using VSCode, since it leverages its client&#x2F;server architecture, each running on Windows and Linux respectively. Typing &lt;code&gt;code .&lt;&#x2F;code&gt; in your terminal will open VSCode. Extensions will be installed server-side.&lt;&#x2F;p&gt;
&lt;p&gt;Other than that, you can enjoy the benefits of using any regular Linux distribution.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;you-can-use-docker&quot;&gt;You can use Docker&lt;&#x2F;h3&gt;
&lt;p&gt;Since the release of WSL 2 (included in the 2004 Windows update), you can use Docker containers inside your Linux distro, managed by your Docker daemon installed on Windows. &quot;All&quot; it requires is using a WSL2 compatible distribution, and enable WSL2 integration in the Docker Desktop preferences.&lt;&#x2F;p&gt;
&lt;p&gt;And, instead of using a virtual machine to host the containers, you can also set Docker Desktop to use... WSL2.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;assets&#x2F;memes&#x2F;brain_explosion.gif&quot; alt=&quot;Brain explosion&quot; title=&quot;Brain explosion&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;I haven&#x27;t made any benchmarks, but I suppose it helps to boost performance.&lt;&#x2F;p&gt;
&lt;p&gt;I suppose you can even use your Kubernetes cluster installed with Docker on Windows from your Linux distribution, but I haven&#x27;t come that far into testing yet.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;accessing-files-between-linux-and-windows&quot;&gt;Accessing files between Linux and Windows&lt;&#x2F;h3&gt;
&lt;p&gt;Your Windows volumes are automatically mounted in &lt;code&gt;&#x2F;mnt&lt;&#x2F;code&gt;, meaning you can literally access anything from your Windows installation. Also, typing &lt;code&gt;explorer.exe .&lt;&#x2F;code&gt; reveals the current folder in Windows&#x27; file manager, shown as a network shared volume.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-bad&quot;&gt;The Bad&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;occasional-bugs-and-freezes&quot;&gt;Occasional bugs and freezes&lt;&#x2F;h3&gt;
&lt;p&gt;I do backend development in Ruby (and Rails), Elixir (and mostly Phoenix) professionally, and I also wrote a bit of Elm and Rust in WSL2. I am quite satisfied with the quality of the integration WSL2 offers, but it isn&#x27;t bug-free either.&lt;&#x2F;p&gt;
&lt;p&gt;For example, when I first tried Zola and ran its web server, I just couldn&#x27;t connect to it with my browser. Firefox was just displaying &quot;Unable to connect&quot;. The reason? I don&#x27;t know, but running &lt;code&gt;wsl.exe --shutdown&lt;&#x2F;code&gt; would &quot;solve&quot; this problem. I&#x27;m obviously more annoyed by the fact that I &lt;em&gt;need&lt;&#x2F;em&gt; to reboot than the fact that I only lose a few seconds of my time every week or so.&lt;&#x2F;p&gt;
&lt;p&gt;But the most annoying thing was occurring during the compilation of my Rust project through Docker (it never happened when I was building &quot;on bare metal&quot;), which was the complete freeze of VSCode, my terminal, and really, any app related to WSL. In that case, I&#x27;d need to wait for a few minutes for the build to finish and my system to be responsive again. I assume this has something to do with my building process eating all of the IO reserved for WSL, or something related to this weird Docker setup.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;wondering-about-long-term-stability&quot;&gt;Wondering about long-term stability&lt;&#x2F;h3&gt;
&lt;p&gt;While Microsoft provided a migration script to switch from WSL to WSL2 (through the use of &lt;code&gt;wsl.exe&lt;&#x2F;code&gt;, to run in &lt;code&gt;cmd.exe&lt;&#x2F;code&gt; or PowerShell), it never worked on the Ubuntu I installed a few months ago, so I tried a few several other distributions (Alpine, Arch) after finally installing a fresh new Ubuntu, which worked instantly with Docker integration. I think not all distributions available on the store are compatible with WSL2, but information is a bit scarce.&lt;&#x2F;p&gt;
&lt;p&gt;So far, my setup has been very stable, but I wonder if a future Windows update could break the whole thing. I got almost anything versioned and hosted somewhere, but still.
And sure, there&#x27;s bugtracking through Github, but I think WSL as a whole is pretty opaque and hard to debug yourself.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-ugly&quot;&gt;The Ugly&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;get-out-of-my-path&quot;&gt;Get out of my $PATH&lt;&#x2F;h3&gt;
&lt;p&gt;To achieve a seemless integration with Windows, my Ubuntu installation has basically the whole Windows mess injected into its default $PATH:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;  &#x2F; echo $PATH
&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;home&#x2F;makks&#x2F;.asdf&#x2F;shims:&#x2F;home&#x2F;makks&#x2F;.asdf&#x2F;bin:&#x2F;home&#x2F;makks&#x2F;.cargo&#x2F;bin:&#x2F;home&#x2F;makks&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;mnt&#x2F;c&#x2F;Windows&#x2F;system32:&#x2F;mnt&#x2F;c&#x2F;Windows:&#x2F;mnt&#x2F;c&#x2F;Windows&#x2F;System32&#x2F;Wbem:&#x2F;mnt&#x2F;c&#x2F;Windows&#x2F;System32&#x2F;WindowsPowerShell&#x2F;v1.0&#x2F;:&#x2F;mnt&#x2F;c&#x2F;Windows&#x2F;System32&#x2F;OpenSSH&#x2F;:&#x2F;mnt&#x2F;c&#x2F;Program Files&#x2F;NVIDIA Corporation&#x2F;NVIDIA NvDLISR:&#x2F;mnt&#x2F;c&#x2F;Program Files (x86)&#x2F;NVIDIA Corporation&#x2F;PhysX&#x2F;Common:&#x2F;mnt&#x2F;c&#x2F;Program Files&#x2F;Git&#x2F;cmd:&#x2F;mnt&#x2F;c&#x2F;WINDOWS&#x2F;system32:&#x2F;mnt&#x2F;c&#x2F;WINDOWS:&#x2F;mnt&#x2F;c&#x2F;WINDOWS&#x2F;System32&#x2F;Wbem:&#x2F;mnt&#x2F;c&#x2F;WINDOWS&#x2F;System32&#x2F;WindowsPowerShell&#x2F;v1.0&#x2F;:&#x2F;mnt&#x2F;c&#x2F;WINDOWS&#x2F;System32&#x2F;OpenSSH&#x2F;:&#x2F;mnt&#x2F;c&#x2F;Program Files&#x2F;Docker&#x2F;Docker&#x2F;resources&#x2F;bin:&#x2F;mnt&#x2F;c&#x2F;ProgramData&#x2F;DockerDesktop&#x2F;version-bin:&#x2F;mnt&#x2F;c&#x2F;Users&#x2F;Makks&#x2F;.cargo&#x2F;bin:&#x2F;mnt&#x2F;c&#x2F;Users&#x2F;Makks&#x2F;AppData&#x2F;Local&#x2F;Microsoft&#x2F;WindowsApps:&#x2F;mnt&#x2F;c&#x2F;Users&#x2F;Makks&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;bin:&#x2F;mnt&#x2F;c&#x2F;Users&#x2F;Makks.cargo&#x2F;bin:&#x2F;mnt&#x2F;c&#x2F;Users&#x2F;Makks&#x2F;AppData&#x2F;Local&#x2F;GitHubDesktop&#x2F;bin:&#x2F;mnt&#x2F;c&#x2F;Users&#x2F;Makks&#x2F;AppData&#x2F;Local&#x2F;Microsoft&#x2F;WindowsApps
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Whish is... yeah. It itched me in many places when I saw this, and when I saw random DLLs popping in my autocompletion. But this is sadly probably the price to pay for this kind of integration.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;devblogs.microsoft.com&#x2F;commandline&#x2F;automatically-configuring-wsl&#x2F;&quot;&gt;There&#x27;s a setting to disable this&lt;&#x2F;a&gt; (and even a few other things), but my distro just didn&#x27;t cared about my feelings and refused to apply it. Judging by the comments section, I&#x27;m not alone in this situation.&lt;&#x2F;p&gt;
&lt;p&gt;This kind of dirty black magic may annoy you if you want your distro to be 100% clean. But I guess you wouldn&#x27;t want to use WSL in the first place in that was the case ;)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;m very satisfied with WSL and its related developments so far. My primary reason for using it is the need for good UI and accessibility tools, because I have an extremely low vision (but I&#x27;ll run into details in a future article) but it&#x27;s also really satisfying to leverage a good CPU (in that case, a Ryzen 3800X) instead of the traditional coughing overpriced Macbook Pro any startup company grants its employees with.&lt;&#x2F;p&gt;
&lt;p&gt;And of course, you can launch a game or two when you need a break.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Rails: Deprecate an ActiveRecord attribute</title>
          <pubDate>Sat, 15 Aug 2020 00:00:00 +0000</pubDate>
          <author>mbuffa@users.noreply.github.com (Maxime Buffa)</author>
          <link>https://mbuffa.github.io/articles/20200815-rails-deprecate-activerecord-attribute/</link>
          <guid>https://mbuffa.github.io/articles/20200815-rails-deprecate-activerecord-attribute/</guid>
          <description xml:base="https://mbuffa.github.io/articles/20200815-rails-deprecate-activerecord-attribute/">&lt;h2 id=&quot;context&quot;&gt;Context&lt;&#x2F;h2&gt;
&lt;p&gt;When working on a growing application relying on a database, it is not uncommon to have a data model that collects dust: some of its data may become obsolete, but you may not want to delete it just yet, because you may need to migrate it, prepare its deletion later or keep it as history.&lt;&#x2F;p&gt;
&lt;p&gt;You might want to flag this data as deprecated, so that no one (including you) would rely on this no longer updated or relevant data.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;how&quot;&gt;How&lt;&#x2F;h2&gt;
&lt;p&gt;You could of course add comments in your code, but there would be no guarantee someone would check those comments before using those attributes. Also, you wouldn&#x27;t notice anything if existing code would use those attributes indirectly.&lt;&#x2F;p&gt;
&lt;p&gt;Fortunately, Rails provides &lt;a href=&quot;https:&#x2F;&#x2F;apidock.com&#x2F;rails&#x2F;v4.0.2&#x2F;Module&#x2F;deprecate&quot;&gt;a nice way to flag ActiveRecord attributes as obsolete&lt;&#x2F;a&gt;, stabilized since Rails 4.x.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s create a &lt;code&gt;Deprecator&lt;&#x2F;code&gt; class, that&#x27;ll embed any behavior we&#x27;d like to implement. We can be creative here, like:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;logging the action&lt;&#x2F;li&gt;
&lt;li&gt;logging parts of the stacktrace&lt;&#x2F;li&gt;
&lt;li&gt;shaming your coworkers on Slack with a bot message&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;But let&#x27;s keep it simple for the time being:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ruby&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-ruby &quot;&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# app&#x2F;deprecators&#x2F;field_deprecator.rb
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;FieldDeprecator
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eff1f5;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;deprecation_warning&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;field&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;replacement&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;_caller_backtrace &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;nil&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    message = &amp;quot;#{field}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt; is deprecated, please favor &lt;&#x2F;span&gt;&lt;span&gt;#{replacement}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Kernel&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;warn&lt;&#x2F;span&gt;&lt;span&gt; message
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We&#x27;re not respecting the semantics of the second argument, but hey, this is duck-typing :trollface:&lt;&#x2F;p&gt;
&lt;p&gt;Then, all we have to do is to add a call to this class method in our model:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ruby&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-ruby &quot;&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;Racoon &lt;&#x2F;span&gt;&lt;span style=&quot;color:#eff1f5;&quot;&gt;&amp;lt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;ApplicationRecord
&lt;&#x2F;span&gt;&lt;span&gt;  deprecate \
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;owner_id: &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Racoon#caretaker_id&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;# ... any other attribute you need to deprecate.
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;deprecator: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ebcb8b;&quot;&gt;FieldDeprecator&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;new
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With our current deprecator, this would output a warning message everytime this field is being read and updated:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; Racoon.first.owner_id
&lt;&#x2F;span&gt;&lt;span&gt;owner_id is deprecated, please favor Racoon#caretaker_id
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;em&gt;Et voil.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
</description>
      </item>
    </channel>
</rss>
